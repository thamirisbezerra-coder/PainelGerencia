<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Gerente - Gestão Visual</title>
    <!-- Favicon adicionado -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/76mXWMJh/as-02.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b;
        }
        
        /* Animações Suaves */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Scrollbar Elegante */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Login Card */
        .login-card {
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
            background: white;
        }
        .login-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.08);
        }
        .login-card.selected {
            background-color: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }

        /* Efeito de Brilho no Logo */
        @keyframes logoGlow {
            0% { 
                filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.2)); 
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.6)); 
                transform: scale(1.05);
            }
            100% { 
                filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.2)); 
                transform: scale(1);
            }
        }
        .logo-shine {
            animation: logoGlow 3s infinite ease-in-out;
        }

        /* Avatar do Vendedor */
        .avatar-initials {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Card do Vendedor na Lista */
        .seller-card {
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .seller-card:hover {
            background-color: #f1f5f9;
        }
        .seller-card.active {
            background-color: #eff6ff; /* blue-50 */
            border-color: #bfdbfe; /* blue-200 */
        }
        .seller-card.active .seller-name {
            color: #1d4ed8; /* blue-700 */
        }

        /* Estrela de Favorito */
        .star-btn {
            transition: transform 0.1s;
        }
        .star-btn:active {
            transform: scale(1.2);
        }
        .star-btn:hover {
            color: #fbbf24; /* amber-400 */
        }

        /* Marca D'água com Ícones SVG */
        .watermark-icon {
            position: absolute;
            bottom: -15px;
            right: -15px;
            width: 100px;
            height: 100px;
            opacity: 0.15; /* Sutil, mas visível */
            pointer-events: none;
            z-index: 0;
            transform: rotate(-12deg);
            transition: transform 0.3s ease;
        }
        
        /* Efeito hover no card movimenta levemente a marca d'água */
        .group:hover .watermark-icon {
            transform: rotate(0deg) scale(1.1);
            opacity: 0.2;
        }

        .watermark-feed-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            opacity: 0.03;
            pointer-events: none;
            z-index: 0;
            color: #94a3b8;
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col bg-slate-50">

    <!-- TELA DE LOGIN -->
    <div id="login-view" class="fixed inset-0 z-50 bg-slate-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-xl w-full max-w-5xl p-8 lg:p-12 fade-in border border-slate-100 flex flex-col lg:flex-row gap-12 max-h-[95vh] overflow-y-auto">
            
            <!-- Lado Esquerdo -->
            <div class="lg:w-5/12 flex flex-col justify-center items-center text-center">
                <div class="mb-8 w-full">
                    <!-- LOGO COM BRILHO E CENTRALIZADO -->
                    <div class="relative inline-block mb-6">
                        <div class="absolute inset-0 bg-blue-400 opacity-20 blur-2xl rounded-full"></div>
                        <img src="https://i.postimg.cc/76mXWMJh/as-02.png" alt="Logo" class="h-32 w-auto object-contain relative z-10 logo-shine mx-auto">
                    </div>
                    
                    <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Painel do Gerente</h1>
                    <p class="text-slate-500 mt-2 text-sm">Selecione seu segmento e insira sua senha.</p>
                </div>

                <div class="space-y-5 max-w-sm w-full">
                    <div>
                        <input type="password" id="manager-password-input" class="w-full border border-slate-200 bg-slate-50 rounded-xl py-3.5 px-4 text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder-slate-400 font-medium text-center" placeholder="Senha de acesso">
                    </div>

                    <button id="manager-login-btn" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-3.5 rounded-xl shadow-lg transition-all active:scale-[0.98] flex justify-center items-center gap-2">
                        <span>Entrar</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                    
                    <p id="login-error" class="text-red-500 text-sm font-medium text-center min-h-[1.25rem]"></p>
                </div>
            </div>

            <!-- Lado Direito: Grid de Seleção -->
            <div class="lg:w-7/12 border-t lg:border-t-0 lg:border-l border-slate-100 pt-8 lg:pt-0 lg:pl-12 flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Segmentos Disponíveis</label>
                </div>
                <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                    <div id="segment-grid" class="grid grid-cols-2 md:grid-cols-2 gap-3">
                        <!-- Cards gerados via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAINEL PRINCIPAL (DASHBOARD) -->
    <div id="dashboard-view" class="hidden flex-col min-h-screen">
        
        <!-- Header Compacto -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm backdrop-blur-md bg-white/90">
            <div class="container mx-auto px-4 py-2 flex justify-between items-center h-14">
                <div class="flex items-center gap-3">
                    <img src="https://i.postimg.cc/76mXWMJh/as-02.png" alt="Logo" class="h-6 w-auto">
                    <div class="h-4 w-px bg-slate-300 hidden sm:block"></div>
                    <div>
                        <h1 class="text-xs text-slate-500 font-medium leading-none">Painel Gerencial</h1>
                        <p id="header-segment-name" class="text-sm font-bold text-slate-800 leading-tight">---</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- Status Sessão -->
                    <div class="hidden md:flex items-center gap-2 px-3 py-1 bg-slate-100 rounded-full">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        <span id="session-id-display" class="text-[10px] font-mono text-slate-600">---</span>
                    </div>

                    <!-- Botão Notas -->
                    <button onclick="document.getElementById('internal-notes-modal').classList.remove('hidden')" class="p-2 text-slate-400 hover:text-yellow-600 hover:bg-yellow-50 rounded-lg transition-colors relative group" title="Notas">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </button>

                    <!-- Logout -->
                    <button id="logout-btn" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 container mx-auto p-4 lg:p-6 space-y-6 max-w-[1600px]">
            
            <!-- Cards de KPI com Ícones Temáticos (SVG) -->
            <section class="grid grid-cols-2 md:grid-cols-4 gap-3">
                
                <!-- Total -->
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group hover:border-blue-300 transition-colors">
                    <p class="text-[10px] font-bold text-slate-400 uppercase z-10 relative">Total de Amostras</p>
                    <p id="kpi-total" class="text-2xl font-bold text-slate-800 z-10 relative">0</p>
                    <!-- Ícone Caixa/Arquivo -->
                    <svg class="watermark-icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>

                <!-- Pendentes -->
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 shadow-sm relative overflow-hidden group">
                    <p class="text-[10px] font-bold text-yellow-600 uppercase z-10 relative">Pendentes</p>
                    <p id="kpi-pending" class="text-2xl font-bold text-yellow-700 z-10 relative">0</p>
                    <!-- Ícone Relógio -->
                    <svg class="watermark-icon text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>

                <!-- Aprovados -->
                <div class="bg-green-50 p-4 rounded-xl border border-green-200 shadow-sm relative overflow-hidden group">
                    <p class="text-[10px] font-bold text-green-600 uppercase z-10 relative">Aprovados</p>
                    <p id="kpi-approved" class="text-2xl font-bold text-green-700 z-10 relative">0</p>
                    <!-- Ícone Check/Sucesso -->
                    <svg class="watermark-icon text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>

                <!-- Reprovados -->
                <div class="bg-red-50 p-4 rounded-xl border border-red-200 shadow-sm relative overflow-hidden group">
                    <p class="text-[10px] font-bold text-red-600 uppercase z-10 relative">Reprovados</p>
                    <p id="kpi-rejected" class="text-2xl font-bold text-red-700 z-10 relative">0</p>
                    <!-- Ícone X/Erro -->
                    <svg class="watermark-icon text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </section>

            <!-- ÁREA DE DESTAQUE (FAVORITOS) -->
            <section id="attention-section" class="bg-amber-50 border border-amber-200 rounded-2xl p-5 shadow-sm hidden transition-all">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-5 h-5 text-amber-500 fill-amber-500" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588 1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                    <h2 class="text-sm font-bold text-amber-900 uppercase tracking-wide">Pontos de Atenção Favoritados</h2>
                </div>
                <div id="attention-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                    <!-- Cards de atenção via JS -->
                </div>
            </section>

            <!-- LAYOUT PRINCIPAL: LISTA VENDEDORES (ESQ) + FEED (DIR) -->
            <div class="flex flex-col lg:flex-row gap-6 items-start h-[calc(100vh-280px)] min-h-[600px]">
                
                <!-- COLUNA 1: LISTA DE VENDEDORES -->
                <div class="w-full lg:w-1/3 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden">
                    <!-- Header da Lista -->
                    <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-slate-700 text-sm">Equipe</h3>
                        <span id="seller-count-badge" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>

                    <!-- Botão "Ver Todos" -->
                    <div class="p-2 border-b border-slate-50 shrink-0">
                        <button id="btn-show-all-sellers" class="w-full text-left px-3 py-2 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            </div>
                            <span>Ver Todos os Vendedores</span>
                        </button>
                    </div>

                    <!-- Lista Scrollável -->
                    <div id="sellers-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                        <p class="text-center text-slate-400 text-xs py-8">Carregando...</p>
                    </div>
                </div>

                <!-- COLUNA 2: FEED DE AMOSTRAS -->
                <div class="w-full lg:w-2/3 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden relative group">
                    
                    <!-- Ícone de Fundo do Feed (Substituindo Logo) -->
                    <svg class="watermark-feed-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="0.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>

                    <!-- Header do Feed com Filtro de Data -->
                    <div class="p-4 border-b border-slate-100 bg-slate-50 flex flex-col gap-3 shrink-0 z-10">
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                            <div class="flex items-center gap-3 w-full sm:w-auto">
                                <div id="current-view-avatar" class="hidden sm:flex w-10 h-10 rounded-full bg-blue-600 items-center justify-center text-white font-bold text-sm shadow-sm avatar-initials">
                                    ALL
                                </div>
                                <div>
                                    <h3 id="feed-title" class="font-bold text-slate-800 text-base">Visão Geral</h3>
                                    <p id="feed-subtitle" class="text-xs text-slate-500">Exibindo todas as amostras</p>
                                </div>
                            </div>
                            <div class="w-full sm:w-auto relative">
                                <input type="text" id="feed-search" placeholder="Buscar produto, nota..." class="w-full sm:w-64 text-sm border-slate-200 bg-white rounded-lg pl-9 pr-3 py-2 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                                <svg class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                        </div>
                        
                        <!-- FILTRO DE PERÍODO -->
                        <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-200 shadow-sm w-full sm:w-auto self-start">
                            <span class="text-xs font-bold text-slate-500 uppercase px-1">Período NF:</span>
                            <input type="date" id="filter-start-date" class="text-xs border border-slate-200 rounded px-2 py-1 focus:ring-1 focus:ring-blue-500 outline-none text-slate-600">
                            <span class="text-xs text-slate-400">até</span>
                            <input type="date" id="filter-end-date" class="text-xs border border-slate-200 rounded px-2 py-1 focus:ring-1 focus:ring-blue-500 outline-none text-slate-600">
                            <button id="clear-date-filter" class="text-xs text-red-400 hover:text-red-600 px-2 font-medium" title="Limpar Datas">Limpar</button>
                        </div>
                    </div>

                    <!-- Lista Feed Scrollável -->
                    <div id="feed-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50 custom-scrollbar z-10 relative">
                        <!-- Itens do feed injetados aqui -->
                    </div>
                    
                    <!-- Loading Overlay (Opcional) -->
                    <div id="feed-loading" class="absolute inset-0 bg-white/80 flex items-center justify-center z-20 hidden">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                </div>

            </div>

            <!-- Gráficos e Detalhes -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 <!-- Gráfico Status com Ícone -->
                 <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group">
                    <div class="flex justify-between items-center mb-2 z-10 relative">
                         <h3 class="font-bold text-sm text-slate-700">Status Geral</h3>
                         <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">Gráfico</span>
                    </div>
                    <div style="height: 180px;" class="z-10 relative"><canvas id="status-chart"></canvas></div>
                    <svg class="watermark-icon text-slate-300" style="width: 120px; height: 120px; opacity: 0.1;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                 </div>
                 
                 <!-- Gráfico Detalhes com Ícone -->
                 <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group">
                    <div class="flex justify-between items-center mb-2 z-10 relative">
                        <h3 class="font-bold text-sm text-slate-700">Aprovações</h3>
                        <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">Gráfico</span>
                    </div>
                    <div style="height: 180px;" class="z-10 relative"><canvas id="details-chart"></canvas></div>
                    <svg class="watermark-icon text-slate-300" style="width: 120px; height: 120px; opacity: 0.1;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                 </div>
                 
                 <!-- Tipos de Resposta -->
                 <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                    <h3 class="font-bold text-sm text-slate-700 mb-3">Resumo por Tipo</h3>
                    <div id="breakdown-list" class="flex-1 overflow-y-auto max-h-[180px] custom-scrollbar space-y-2 pr-1">
                        <!-- JS -->
                    </div>
                 </div>
            </div>

        </main>
    </div>

    <!-- MODAIS -->

    <!-- Modal Notas Internas -->
    <div id="internal-notes-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md h-[60vh] flex flex-col shadow-2xl overflow-hidden border border-slate-200 scale-in">
            <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-yellow-50">
                <h3 class="font-bold text-yellow-800 text-sm">Notas Internas</h3>
                <button onclick="document.getElementById('internal-notes-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div id="internal-notes-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50"></div>
            <div class="p-3 border-t border-slate-100 bg-white flex gap-2">
                <input type="text" id="new-internal-note-input" placeholder="Nova nota..." class="flex-1 rounded-lg border-slate-200 text-sm px-3 py-2 bg-slate-50">
                <button id="add-internal-note-btn" class="bg-yellow-500 text-white rounded-lg px-3 py-2 shadow-sm hover:bg-yellow-600">Add</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Detalhes Feedback (AGORA COM BOTÃO RESPONDER) -->
    <div id="feedback-samples-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl flex flex-col max-h-[85vh] scale-in">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-blue-50">
                <div>
                    <h3 id="feedback-samples-title" class="text-lg font-bold text-slate-800">Detalhes</h3>
                </div>
                <button id="close-feedback-samples-btn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            </div>
            <div class="flex-1 overflow-auto p-0 bg-white">
                <table class="w-full text-left border-collapse text-xs">
                    <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm text-slate-500 uppercase font-semibold">
                        <tr>
                            <th class="p-3">Ação</th>
                            <th class="p-3">Vendedor</th>
                            <th class="p-3">Cliente</th>
                            <th class="p-3">Produto</th>
                            <th class="p-3">Descrição</th>
                            <th class="p-3">Pedido/NF</th>
                            <th class="p-3">Feedback</th>
                        </tr>
                    </thead>
                    <tbody id="feedback-samples-list" class="divide-y divide-slate-100 text-slate-600"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Resposta -->
    <div id="reply-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-[70]">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 scale-in">
            <h3 class="text-lg font-bold mb-4 text-slate-800">Responder ao Vendedor</h3>
            <div class="mb-4 p-4 bg-slate-50 rounded-xl border border-slate-100 text-sm">
                <div class="flex justify-between mb-1">
                    <p class="font-bold text-slate-700" id="reply-modal-product"></p>
                    <p class="text-xs text-slate-500" id="reply-modal-seller"></p>
                </div>
                <p class="italic text-slate-600 border-l-2 border-slate-300 pl-2 mt-2" id="reply-modal-observation">"..."</p>
            </div>
            <div class="space-y-4">
               <textarea id="reply-message-input" rows="3" class="w-full border-slate-300 rounded-xl shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-3" placeholder="Escreva sua orientação para o vendedor..."></textarea>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                 <button id="cancel-reply-btn" class="text-slate-500 font-semibold px-4 py-2 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                 <button id="send-reply-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-colors">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Alert Custom -->
    <div id="custom-alert" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-[80]">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center scale-in">
            <h3 id="custom-alert-title" class="text-lg font-bold mb-2">Aviso</h3>
            <p id="custom-alert-message" class="text-sm text-slate-600 mb-6">Mensagem...</p>
            <button id="custom-alert-ok-btn" class="bg-slate-900 text-white font-bold py-2 px-8 rounded-full hover:bg-black transition-colors">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, getDocs, 
            updateDoc, setDoc, query, where, Timestamp, runTransaction, addDoc, orderBy, deleteDoc, deleteField, serverTimestamp, arrayUnion, arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // CONFIGURAÇÃO DOS GERENTES
        const MANAGERS = {
            'CÁRNEOS': { name: 'LUIS ADRIANO', pass: 'carneospass123', dataValue: 'CARNEOS' },
            'LACTEOS': { name: 'VITOR MACHADO', pass: 'lacteospass456', dataValue: 'LACTEOS' },
            'NUTRIÇÃO ESPORTIVA': { name: 'JOÃO SCHITTKOWSKI', pass: 'esportivapass123', dataValue: 'NUTRIÇÃO ESPORTIVA' },
            'FARMA': { name: 'VANESSA BADARÓ', pass: 'farmapass123', dataValue: 'FARMA' },
            'NUTRICAO ANIMAL': { name: 'DANILO TREMOLCOLDI', pass: 'nutricaopass303', dataValue: 'NUTRICAO ANIMAL' },
            'PANIFICACAO': { name: 'MARISTELA', pass: 'panificacaopass101', dataValue: 'PANIFICACAO' },
            'SMB': { name: 'GUSTAVO BONFIM', pass: 'smbpass202', dataValue: 'SNACKS, MOLHOS E BEBIDAS' },
            'SORVETES': { name: 'VINICIUS MADALENO', pass: 'sorvetespass789', dataValue: 'SORVETES' },
            'ADMIN': { name: 'Admin', pass: 'admin123', dataValue: 'ADMIN' }
        };

        const SPECIAL_MAPPING = {
            'FERNANDA BEATRIZ': 'NUTRIÇÃO ESPORTIVA',
            'ANDREIA TINTI': 'NUTRIÇÃO ESPORTIVA',
            'PATRICIA CORREIA': 'NUTRIÇÃO ESPORTIVA',
            'KARLA ALMEIDA': 'NUTRIÇÃO ESPORTIVA'
        };

        const PENDING_STATUSES = ['EM ANÁLISE', 'AMOSTRA SEM FEEDBACK', 'SEM RETORNO DO CLIENTE', 'AMOSTRA NÃO TESTADA', 'PENDENTE'];
        
        // Elementos DOM Principais
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const segmentGrid = document.getElementById('segment-grid');
        const passwordInput = document.getElementById('manager-password-input');
        const loginBtn = document.getElementById('manager-login-btn');
        const loginError = document.getElementById('login-error');
        const feedList = document.getElementById('feed-list');
        const sellersList = document.getElementById('sellers-list');
        const btnShowAllSellers = document.getElementById('btn-show-all-sellers');
        
        // Filtros de Data
        const filterStartDate = document.getElementById('filter-start-date');
        const filterEndDate = document.getElementById('filter-end-date');
        const clearDateFilter = document.getElementById('clear-date-filter');

        // Estado
        let currentSegmentKey = null; 
        let currentSegmentDataValue = null; 
        let currentSessionId = null;
        let selectedSellerFilter = null; // null = Todos
        let allSegmentSamples = []; 
        let highlightedSamplesCache = [];
        let managerReplies = [];
        let itemNotesMap = {};
        let sellerSegmentsCache = {}; 
        let statusChart = null;
        let detailsChart = null;
        
        // Cores para avatares
        const AVATAR_COLORS = [
            'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-green-500', 'bg-emerald-500',
            'bg-teal-500', 'bg-cyan-500', 'bg-sky-500', 'bg-blue-500', 'bg-indigo-500',
            'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500', 'bg-pink-500', 'bg-rose-500'
        ];

        // --- Inicialização ---
        (async () => {
            try {
                await signInAnonymously(auth);
                renderLoginSegments();
                const savedKey = localStorage.getItem('managerSegmentKey');
                if (savedKey && MANAGERS[savedKey]) autoSelectSegment(savedKey);
            } catch (e) { console.error(e); }
        })();

        // --- Utils ---
        const normalizeText = (text = '') => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim().replace(/\s+/g, ' ') : '';
        const getInitials = (name) => {
            const parts = name.trim().split(' ');
            if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        };
        const getAvatarColor = (name) => {
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
        };
        function showAlert(msg, title = "Aviso") {
            document.getElementById('custom-alert-title').textContent = title;
            document.getElementById('custom-alert-message').innerHTML = msg;
            document.getElementById('custom-alert').classList.remove('hidden');
        }
        document.getElementById('custom-alert-ok-btn').onclick = () => document.getElementById('custom-alert').classList.add('hidden');

        // Helper para Data
        function parseDateBR(dateStr) {
            if (!dateStr) return null;
            // Tenta converter se for timestamp do firestore
            if (typeof dateStr === 'object' && dateStr.toDate) return dateStr.toDate();
            
            // Se for string DD/MM/YYYY
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateStr); // Tenta formato padrão
        }

        // --- Login Logic ---
        function renderLoginSegments() {
            segmentGrid.innerHTML = '';
            Object.entries(MANAGERS).filter(([k]) => k !== 'ADMIN').forEach(([key, data]) => {
                const btn = document.createElement('button');
                btn.className = 'login-card text-left p-4 rounded-xl cursor-pointer flex flex-col justify-between h-24 relative overflow-hidden group';
                btn.innerHTML = `<span class="font-bold text-xs text-slate-700 z-10">${key}</span><span class="text-[10px] text-slate-500 z-10">${data.name}</span>`;
                btn.onclick = () => selectSegment(btn, key);
                segmentGrid.appendChild(btn);
            });
        }

        function selectSegment(btn, key) {
            document.querySelectorAll('.login-card').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            currentSegmentKey = key;
            currentSegmentDataValue = MANAGERS[key].dataValue;
            passwordInput.focus();
        }

        function autoSelectSegment(key) {
            const btns = Array.from(document.querySelectorAll('.login-card'));
            const target = btns.find(b => b.innerText.includes(key));
            if(target) selectSegment(target, key);
        }

        loginBtn.addEventListener('click', async () => {
            if (!currentSegmentKey && passwordInput.value === MANAGERS['ADMIN'].pass) { currentSegmentKey = 'ADMIN'; currentSegmentDataValue = 'ADMIN'; }
            if (!currentSegmentKey || passwordInput.value !== MANAGERS[currentSegmentKey].pass) { loginError.textContent = "Credenciais inválidas."; return; }

            loginBtn.textContent = "Entrando...";
            localStorage.setItem('managerSegmentKey', currentSegmentKey);
            
            try {
                const configSnap = await getDoc(doc(db, "configuracoes", "sessaoAtiva"));
                if (configSnap.exists() && configSnap.data().current) {
                    currentSessionId = configSnap.data().current;
                    await loadSellerSegmentsCache(); 
                    startDashboard();
                } else {
                    loginError.textContent = "Sem sessão ativa.";
                    loginBtn.textContent = "Entrar";
                }
            } catch (e) { console.error(e); }
        });

        async function loadSellerSegmentsCache() {
            try {
                const snap = await getDocs(collection(db, "vendedorConfig"));
                sellerSegmentsCache = {};
                snap.forEach(d => {
                    sellerSegmentsCache[d.id] = d.data().segmento;
                });
            } catch (e) {
                console.error("Erro ao carregar segmentos:", e);
            }
        }

        // --- Dashboard Logic ---
        function startDashboard() {
            loginView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            dashboardView.classList.add('flex');
            
            document.getElementById('header-segment-name').textContent = `${MANAGERS[currentSegmentKey].name}`;
            document.getElementById('session-id-display').textContent = currentSessionId.split('_')[1] || 'Sessão';

            onSnapshot(collection(db, "sessoes", currentSessionId, "vendedores"), processSnapshot);
            
            onSnapshot(doc(db, "sessoes", currentSessionId, "configuracoes", "destaquesAmostras"), (docSnap) => {
                highlightedSamplesCache = docSnap.exists() ? (docSnap.data().lista || []) : [];
                renderFeed(); 
                renderAttentionArea();
            });

            onSnapshot(query(collection(db, "sessoes", currentSessionId, "notificacoesVendedor")), (snap) => {
                managerReplies = snap.docs.map(d => ({...d.data(), id: d.id}));
                // Ordena respostas mais recentes primeiro
                managerReplies.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderFeed();
            });
            
            onSnapshot(query(collection(db, "sessoes", currentSessionId, "manager_item_notes"), where("segment", "==", currentSegmentDataValue)), (snap) => {
                itemNotesMap = {};
                snap.docs.forEach(d => itemNotesMap[d.id] = d.data());
                renderFeed();
            });

            onSnapshot(query(collection(db, "sessoes", currentSessionId, "manager_notes_" + currentSegmentDataValue.replace(/\s+/g, '_')), orderBy("timestamp", "desc")), renderInternalNotes);
        }

        function processSnapshot(snapshot) {
            allSegmentSamples = [];
            let sellersData = {};

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const sellerId = docSnap.id;
                const sName = normalizeText(data.originalName);

                let sellerSegment = sellerSegmentsCache[sellerId];
                if (SPECIAL_MAPPING[sName]) sellerSegment = SPECIAL_MAPPING[sName];
                
                if (!sellerSegment && currentSegmentKey !== 'ADMIN') {
                     if (sName.includes(currentSegmentDataValue)) sellerSegment = currentSegmentDataValue;
                }

                if (currentSegmentKey !== 'ADMIN' && sellerSegment !== currentSegmentDataValue) return;

                const samples = data.amostras || [];
                let pendingCount = 0;
                
                samples.forEach(s => {
                    let isP = s.isPending;
                    if (isP === undefined) isP = PENDING_STATUSES.includes(normalizeText(s.originalStatus));
                    if (isP) pendingCount++;
                    s.sellerName = data.originalName; 
                    s.sellerId = sellerId;
                });

                if (samples.length > 0) {
                     allSegmentSamples.push(...samples);
                     sellersData[data.originalName] = {
                         id: sellerId,
                         name: data.originalName,
                         total: samples.length,
                         pending: pendingCount,
                         finished: samples.length - pendingCount
                     };
                }
            });

            renderKPIs();
            renderSellersList(sellersData);
            renderFeed();
            renderCharts();
            renderBreakdown();
        }

        // --- Renderização Nova da Lista de Vendedores ---
        function renderSellersList(sellersData) {
            sellersList.innerHTML = '';
            const sortedSellers = Object.values(sellersData).sort((a, b) => b.pending - a.pending);
            document.getElementById('seller-count-badge').textContent = sortedSellers.length;

            if (sortedSellers.length === 0) {
                sellersList.innerHTML = '<div class="text-center p-4 text-slate-400 text-xs">Nenhum vendedor encontrado para este segmento.</div>';
                return;
            }

            sortedSellers.forEach(seller => {
                const div = document.createElement('div');
                const isSelected = selectedSellerFilter === seller.name;
                const initials = getInitials(seller.name);
                const colorClass = getAvatarColor(seller.name);
                
                div.className = `seller-card flex items-center gap-3 p-3 rounded-xl border mb-1 group relative ${isSelected ? 'active border-blue-200 bg-blue-50 shadow-sm' : 'border-transparent hover:bg-slate-50'}`;
                
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full ${colorClass} shrink-0 avatar-initials text-xs shadow-sm ring-2 ring-white">
                        ${initials}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="seller-name text-xs font-bold text-slate-700 truncate group-hover:text-blue-600 transition-colors">${seller.name}</p>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-[10px] text-slate-500 font-medium">${seller.total} total</span>
                            ${seller.pending > 0 
                                ? `<span class="px-1.5 py-0.5 rounded bg-yellow-100 text-yellow-700 text-[9px] font-bold">${seller.pending} pend</span>` 
                                : `<span class="text-[10px] text-green-600 font-bold flex items-center gap-0.5"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>OK</span>`}
                        </div>
                    </div>
                    ${isSelected ? `<div class="absolute right-2 w-2 h-2 rounded-full bg-blue-500"></div>` : ''}
                `;
                
                div.onclick = () => {
                    selectedSellerFilter = seller.name;
                    renderSellersList(sellersData);
                    renderFeed();
                };
                sellersList.appendChild(div);
            });
        }

        btnShowAllSellers.onclick = () => {
            selectedSellerFilter = null;
            document.querySelectorAll('.seller-card').forEach(c => c.classList.remove('active', 'bg-blue-50', 'border-blue-200'));
            renderFeed();
        };

        // --- Renderização do Feed com Filtro de Data e Respostas Visíveis ---
        function renderFeed() {
            const searchTerm = document.getElementById('feed-search').value.toLowerCase();
            feedList.innerHTML = '';
            
            // Datas do Filtro
            let start = filterStartDate.value ? new Date(filterStartDate.value) : null;
            let end = filterEndDate.value ? new Date(filterEndDate.value) : null;
            if (end) end.setHours(23,59,59); // Final do dia

            const headerTitle = document.getElementById('feed-title');
            const headerSubtitle = document.getElementById('feed-subtitle');
            const headerAvatar = document.getElementById('current-view-avatar');

            if (selectedSellerFilter) {
                headerTitle.textContent = selectedSellerFilter;
                headerSubtitle.textContent = "Filtrado por vendedor";
                headerAvatar.className = `hidden sm:flex w-10 h-10 rounded-full items-center justify-center text-white font-bold text-sm shadow-sm avatar-initials ${getAvatarColor(selectedSellerFilter)}`;
                headerAvatar.textContent = getInitials(selectedSellerFilter);
            } else {
                headerTitle.textContent = "Visão Geral";
                headerSubtitle.textContent = `Exibindo ${allSegmentSamples.length} amostras`;
                headerAvatar.className = "hidden sm:flex w-10 h-10 rounded-full bg-slate-800 items-center justify-center text-white font-bold text-sm shadow-sm avatar-initials";
                headerAvatar.textContent = "ALL";
            }

            let filtered = allSegmentSamples.filter(s => {
                const matchesSearch = String(s.produto).toLowerCase().includes(searchTerm) || 
                                      String(s.sellerName).toLowerCase().includes(searchTerm) ||
                                      String(s.pedido).includes(searchTerm);
                const matchesSeller = selectedSellerFilter ? s.sellerName === selectedSellerFilter : true;
                
                // Filtro de Data (Emissão NF)
                let matchesDate = true;
                if (start || end) {
                    const dateStr = s.emissao || s.dataEmissao || s.emissaoNF;
                    const dateObj = parseDateBR(dateStr);
                    if (dateObj) {
                        if (start && dateObj < start) matchesDate = false;
                        if (end && dateObj > end) matchesDate = false;
                    } else {
                        matchesDate = false; // Se não tem data e filtro está ativo, esconde
                    }
                }

                return matchesSearch && matchesSeller && matchesDate;
            });
            
            filtered.sort((a, b) => {
                const aStar = highlightedSamplesCache.includes(a.id) ? 1 : 0;
                const bStar = highlightedSamplesCache.includes(b.id) ? 1 : 0;
                if (bStar !== aStar) return bStar - aStar;
                return (b.lastUpdate?.seconds || 0) - (a.lastUpdate?.seconds || 0);
            });

            if (filtered.length === 0) {
                feedList.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                        <svg class="w-12 h-12 mb-2 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        <p class="text-sm">Nenhuma amostra encontrada.</p>
                    </div>`;
                return;
            }

            filtered.forEach(item => {
                const isStarred = highlightedSamplesCache.includes(item.id);
                const itemNote = itemNotesMap[item.id];
                
                // Busca respostas para este item
                const replies = managerReplies.filter(r => r.pedido == item.pedido && r.produto == item.produto); 
                
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl border transition-all hover:shadow-md relative group ${isStarred ? 'border-amber-300 shadow-sm ring-1 ring-amber-100' : 'border-slate-200'}`;
                
                let statusColor = 'bg-slate-100 text-slate-600';
                if (!item.feedback) statusColor = 'bg-yellow-100 text-yellow-700';
                else if (item.feedback.startsWith('A -')) statusColor = 'bg-green-100 text-green-700';
                else if (item.feedback.startsWith('R -')) statusColor = 'bg-red-100 text-red-700';

                // Constrói HTML das Respostas
                let repliesHtml = '';
                if (replies.length > 0) {
                    // Mostra a resposta mais recente (primeira da lista filtrada e ordenada)
                    const lastReply = replies[0]; 
                    const replyDate = lastReply.timestamp ? formatDate(lastReply.timestamp) : '';
                    
                    repliesHtml = `
                        <div class="mt-3 bg-blue-50 p-3 rounded-lg border-l-4 border-blue-400">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-bold text-blue-800 uppercase flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                                    Respondido por ${lastReply.managerName || 'Gerente'}
                                </span>
                                <span class="text-[9px] text-blue-400">${replyDate}</span>
                            </div>
                            <p class="text-xs text-blue-900 font-medium italic">"${lastReply.replyMessage}"</p>
                            ${replies.length > 1 ? `<p class="text-[9px] text-blue-400 mt-1 text-right font-bold cursor-pointer">+${replies.length - 1} anteriores</p>` : ''}
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full ${getAvatarColor(item.sellerName)} flex items-center justify-center text-[10px] font-bold text-white">
                                ${getInitials(item.sellerName)}
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-800 leading-tight">${item.sellerName}</p>
                                <p class="text-[10px] text-slate-400">${item.lastUpdate ? formatDate(item.lastUpdate) : 'Recent'}</p>
                            </div>
                        </div>
                        <button class="star-btn p-1.5 rounded-full hover:bg-slate-50 text-slate-300 transition-colors" onclick="window.toggleStar('${item.id}')" title="Favoritar / Ponto de Atenção">
                            <svg class="w-5 h-5 ${isStarred ? 'text-amber-400 fill-amber-400' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                        </button>
                    </div>

                    <div class="pl-10">
                        <div class="flex justify-between items-start gap-2 mb-2">
                            <h4 class="font-bold text-sm text-slate-700">${item.produto}</h4>
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold whitespace-nowrap ${statusColor}">${item.feedback || 'PENDENTE'}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-slate-500 bg-slate-50 p-2.5 rounded-lg mb-2">
                            <p><span class="font-medium text-slate-400">Ped:</span> ${item.pedido}</p>
                            <p class="text-right"><span class="font-medium text-slate-400">Qtde:</span> ${item.qtde}</p>
                            <p class="col-span-2 truncate"><span class="font-medium text-slate-400">Desc:</span> ${item.descricao || '-'}</p>
                            <p class="col-span-2 mt-1 border-t border-slate-200 pt-1"><span class="font-medium text-slate-400">Emissão NF:</span> ${formatDate(item.emissao || item.dataEmissao || item.emissaoNF)}</p>
                        </div>

                        ${item.observation ? `<p class="text-xs text-slate-600 italic border-l-2 border-slate-300 pl-2 mb-2">"${item.observation}"</p>` : ''}
                        
                        <!-- ÁREA DAS RESPOSTAS (Inserida Aqui) -->
                        ${repliesHtml}

                        <div class="flex items-center justify-end gap-3 mt-3 pt-2 border-t border-slate-50">
                             <button class="flex items-center gap-1 text-[10px] font-bold uppercase transition-colors ${itemNote ? 'text-yellow-600' : 'text-slate-400 hover:text-slate-600'}" onclick="document.getElementById('note-area-${item.id}').classList.toggle('hidden')">
                                <svg class="w-4 h-4" fill="${itemNote ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                ${itemNote ? 'Nota Salva' : 'Nota'}
                             </button>

                             <button class="flex items-center gap-1 text-[10px] font-bold uppercase text-blue-500 hover:text-blue-700 transition-colors open-reply-btn" data-id="${item.id}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                                Responder
                             </button>
                        </div>

                        <div id="note-area-${item.id}" class="hidden mt-3 bg-yellow-50 p-2 rounded-lg border border-yellow-100">
                             <textarea class="w-full text-xs bg-transparent border-none p-0 focus:ring-0 text-yellow-900 placeholder-yellow-400/70" rows="2" placeholder="Nota privada...">${itemNote ? itemNote.text : ''}</textarea>
                             <div class="flex justify-end mt-1">
                                <button class="text-[10px] font-bold text-yellow-700 hover:text-yellow-900 save-note-btn" data-id="${item.id}">Salvar Nota</button>
                             </div>
                        </div>
                    </div>
                `;
                feedList.appendChild(card);
            });
            
            document.querySelectorAll('.open-reply-btn').forEach(b => b.onclick = (e) => openReplyModal(e.currentTarget.dataset.id));
            document.querySelectorAll('.save-note-btn').forEach(b => b.onclick = (e) => saveItemNote(e.currentTarget.dataset.id));
        }

        document.getElementById('feed-search').addEventListener('input', renderFeed);
        
        // Listeners para filtro de data
        filterStartDate.addEventListener('change', renderFeed);
        filterEndDate.addEventListener('change', renderFeed);
        clearDateFilter.addEventListener('click', () => {
            filterStartDate.value = '';
            filterEndDate.value = '';
            renderFeed();
        });

        window.toggleStar = async (sampleId) => {
            if (!currentSessionId) return;
            const ref = doc(db, "sessoes", currentSessionId, "configuracoes", "destaquesAmostras");
            const isStarred = highlightedSamplesCache.includes(sampleId);
            
            try {
                if (isStarred) await updateDoc(ref, { lista: arrayRemove(sampleId) });
                else await setDoc(ref, { lista: arrayUnion(sampleId) }, { merge: true });
            } catch(e) { console.error(e); showAlert("Erro ao atualizar favorito."); }
        };

        // --- ÁREA DE ATENÇÃO ---
        function renderAttentionArea() {
            const list = document.getElementById('attention-list');
            const section = document.getElementById('attention-section');
            list.innerHTML = '';
            
            const starredItems = allSegmentSamples.filter(s => highlightedSamplesCache.includes(s.id));
            
            if (starredItems.length > 0) {
                section.classList.remove('hidden');
                starredItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-3 rounded-xl border-l-4 border-amber-400 shadow-sm flex flex-col justify-between h-full';
                    div.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start">
                                <p class="text-xs font-bold text-slate-800 line-clamp-1" title="${item.produto}">${item.produto}</p>
                                <button onclick="window.toggleStar('${item.id}')" class="text-amber-400 hover:text-amber-600"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"></path></svg></button>
                            </div>
                            <p class="text-[10px] text-slate-500 mb-1">${item.sellerName}</p>
                            <p class="text-[10px] text-slate-400 bg-slate-50 p-1 rounded inline-block">Ped: ${item.pedido}</p>
                        </div>
                        <div class="mt-2 pt-2 border-t border-slate-50 text-[10px] font-bold text-slate-600">
                             ${item.feedback || 'Pendente'}
                        </div>
                    `;
                    list.appendChild(div);
                });
            } else {
                section.classList.add('hidden');
            }
        }

        async function saveItemNote(id) {
            const area = document.getElementById(`note-area-${id}`);
            const text = area.querySelector('textarea').value.trim();
            try {
                await setDoc(doc(collection(db, "sessoes", currentSessionId, "manager_item_notes"), id), {
                    text, itemId: id, segment: currentSegmentDataValue, timestamp: serverTimestamp()
                });
                area.classList.add('hidden');
            } catch(e) { showAlert("Erro ao salvar."); }
        }

        function openReplyModal(id) {
            const item = allSegmentSamples.find(s => s.id === id);
            if(!item) return;
            document.getElementById('reply-modal-product').textContent = item.produto;
            document.getElementById('reply-modal-seller').textContent = item.sellerName;
            document.getElementById('reply-modal-observation').textContent = `"${item.observation || ''}"`;
            
            const sendBtn = document.getElementById('send-reply-btn');
            sendBtn.onclick = async () => {
                const msg = document.getElementById('reply-message-input').value.trim();
                if(!msg) return;
                sendBtn.textContent = 'Enviando...';
                await addDoc(collection(db, "sessoes", currentSessionId, "notificacoesVendedor"), {
                     managerName: MANAGERS[currentSegmentKey].name,
                     replyMessage: msg, sellerName: item.sellerName, pedido: item.pedido, produto: item.produto,
                     timestamp: serverTimestamp(), read: false
                });
                document.getElementById('reply-modal').classList.add('hidden');
                document.getElementById('reply-message-input').value = '';
                sendBtn.textContent = 'Enviar';
                showAlert("Resposta enviada!", "Sucesso");
            };
            document.getElementById('cancel-reply-btn').onclick = () => document.getElementById('reply-modal').classList.add('hidden');
            document.getElementById('reply-modal').classList.remove('hidden');
        }

        function renderKPIs() {
            const total = allSegmentSamples.length;
            let p = 0, a = 0, r = 0;
            allSegmentSamples.forEach(s => {
                const fb = s.feedback || '';
                if (!fb) p++;
                else if (fb.startsWith('A -')) a++;
                else if (fb.startsWith('R -')) r++;
                else p++; 
            });
            document.getElementById('kpi-total').textContent = total;
            document.getElementById('kpi-pending').textContent = p;
            document.getElementById('kpi-approved').textContent = a;
            document.getElementById('kpi-rejected').textContent = r;
        }
        
        function renderInternalNotes(snap) {
            const list = document.getElementById('internal-notes-list');
            list.innerHTML = '';
            snap.docs.forEach(d => {
                const n = d.data();
                const el = document.createElement('div');
                el.className = 'bg-yellow-100 p-3 rounded text-xs text-yellow-900 relative group';
                el.innerHTML = `${n.text} <button class="absolute top-1 right-1 text-red-400 opacity-0 group-hover:opacity-100" onclick="deleteInternalNote('${d.id}')">&times;</button>`;
                list.appendChild(el);
            });
        }
        window.deleteInternalNote = async (id) => deleteDoc(doc(db, "sessoes", currentSessionId, "manager_notes_" + currentSegmentDataValue.replace(/\s+/g, '_'), id));
        document.getElementById('add-internal-note-btn').onclick = async () => {
            const val = document.getElementById('new-internal-note-input').value.trim();
            if(val) {
                await addDoc(collection(db, "sessoes", currentSessionId, "manager_notes_" + currentSegmentDataValue.replace(/\s+/g, '_')), { text: val, timestamp: serverTimestamp() });
                document.getElementById('new-internal-note-input').value = '';
            }
        };

        // --- Gráficos Funcionais (Chart.js) ---
        function renderCharts() {
            const ctxStatus = document.getElementById('status-chart').getContext('2d');
            const ctxDetails = document.getElementById('details-chart').getContext('2d');

            let pending = 0, resolved = 0, approved = 0, rejected = 0;
            allSegmentSamples.forEach(s => {
                const fb = s.feedback || '';
                if (!fb || PENDING_STATUSES.includes(fb)) pending++;
                else {
                    resolved++;
                    if (fb.startsWith('A -')) approved++;
                    else if (fb.startsWith('R -')) rejected++;
                }
            });

            if (statusChart) statusChart.destroy();
            if (detailsChart) detailsChart.destroy();

            statusChart = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Pendentes', 'Resolvidos'],
                    datasets: [{
                        data: [pending, resolved],
                        backgroundColor: ['#fcd34d', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: {size: 10}, usePointStyle: true } } },
                    cutout: '70%'
                }
            });

            detailsChart = new Chart(ctxDetails, {
                type: 'doughnut',
                data: {
                    labels: ['Aprovados', 'Reprovados'],
                    datasets: [{
                        data: [approved, rejected],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: {size: 10}, usePointStyle: true } } },
                    cutout: '70%'
                }
            });
        }

        function renderBreakdown() { 
            const list = document.getElementById('breakdown-list');
            list.innerHTML = '';
            const counts = {};
            allSegmentSamples.forEach(s => { const k = s.feedback || 'PENDENTE'; counts[k] = (counts[k]||0)+1; });
            Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([k,v]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between text-xs p-2 border rounded hover:bg-slate-50 cursor-pointer';
                div.innerHTML = `<span>${k}</span><span class="font-bold">${v}</span>`;
                div.onclick = () => openDetailsModal(k);
                list.appendChild(div);
            });
        }

        // --- Detalhes com Botão Responder ---
        function openDetailsModal(type) {
            const list = document.getElementById('feedback-samples-list');
            list.innerHTML = '';
            document.getElementById('feedback-samples-title').textContent = type;
            
            // Renderiza tabela
            allSegmentSamples.filter(s=>(s.feedback||'PENDENTE')===type).forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3">
                        <button class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-[10px] font-bold uppercase transition-colors reply-btn-table" data-id="${s.id}">Responder</button>
                    </td>
                    <td class="p-3 font-bold">${s.sellerName}</td>
                    <td class="p-3">${s.codCliente||'-'}</td>
                    <td class="p-3">${s.produto}</td>
                    <td class="p-3 truncate max-w-[150px]">${s.descricao||'-'}</td>
                    <td class="p-3">${s.pedido}</td>
                    <td class="p-3">${s.feedback||'-'}</td>
                `;
                list.appendChild(tr);
            });

            // Bind clicks na tabela
            document.querySelectorAll('.reply-btn-table').forEach(btn => {
                btn.onclick = (e) => {
                    document.getElementById('feedback-samples-modal').classList.add('hidden');
                    openReplyModal(e.target.dataset.id);
                };
            });

            document.getElementById('feedback-samples-modal').classList.remove('hidden');
        }
        
        document.getElementById('close-feedback-samples-btn').onclick = () => document.getElementById('feedback-samples-modal').classList.add('hidden');
        document.getElementById('logout-btn').onclick = () => { localStorage.removeItem('managerSegmentKey'); location.reload(); };
        
        function formatDate(ts) { if(!ts) return '-'; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleDateString('pt-BR'); }

    </script>
</body>
</html>








































