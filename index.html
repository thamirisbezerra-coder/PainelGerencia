<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gerentes (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

        /* Barra de rolagem para Feed e Lista de Vendedores */
        #sellers-list-container, #observations-feed-list {
            max-height: 448px; /* 28rem */
            overflow-y: auto;
        }

        /* Estilos para o feed de observações e respostas */
        .manager-reply, .seller-reply, .pd-note {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        .manager-reply {
            background-color: #f3f4f6; /* bg-gray-100 */
            border-left: 3px solid #9ca3af; /* border-gray-400 */
        }
        .seller-reply {
            background-color: #f0f9ff; /* bg-blue-50 */
            border-left: 3px solid #60a5fa; /* border-blue-400 */
            margin-left: 1rem; /* Indent seller reply */
        }
         .pd-note {
            background-color: #fffbeb; /* bg-amber-50 */
            border-left: 3px solid #fcd34d; /* border-amber-300 */
            margin-left: 0.5rem;
        }

        /* Estilo para Amostra destacada no modal */
        .feedback-sample-item {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .feedback-sample-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .feedback-sample-item.highlight {
            background-color: #fffbeb; /* bg-amber-50 */
        }

        /* Estilo para os cards de login (sem ícone) */
        .login-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background-color: #f9fafb; /* bg-gray-50 */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            color: #374151; /* text-gray-700 */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: left;
        }
        .login-card:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
            border-color: #d1d5db; /* border-gray-300 */
        }
        .login-card.selected {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            border-color: #2563eb; /* border-blue-700 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .login-card-name {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
            font-weight: 500; /* font-medium */
        }
        .login-card.selected .login-card-name {
            color: #dbeafe; /* text-blue-100 */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Tela de Login -->
    <div id="login-view" class="grid place-items-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 w-full max-w-2xl p-8">
            <div class="flex justify-center items-center gap-3 mb-6">
                <!-- ÍCONE: Malinha (Briefcase) -->
                <div class="p-3 bg-indigo-100 rounded-full">
                    <svg class="w-8 h-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.05c0 .621-.504 1.125-1.125 1.125H4.875A1.125 1.125 0 0 1 3.75 18.2V14.15m16.5 0v-2.175c0-.621-.504-1.125-1.125-1.125H4.875A1.125 1.125 0 0 0 3.75 11.975V14.15m16.5 0A1.125 1.125 0 0 0 21 13.025V9.75A1.125 1.125 0 0 0 19.875 8.625H4.125A1.125 1.125 0 0 0 3 9.75v3.275c0 .621.504 1.125 1.125 1.125M15 8.625V6a1.875 1.875 0 1 0-3.75 0V8.625m3.75 0H9m6 0v-2.625c0-1.036-.84-1.875-1.875-1.875H9.875C8.84 4.125 8 4.964 8 6v2.625m6 0H9" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 text-center">Painel de Gerentes (v2)</h1>
            </div>
            <p class="text-gray-600 text-center mb-8">Selecione o seu segmento para aceder ao painel.</p>
            
            <!-- LAYOUT DE LOGIN (CARDS) -->
            <div id="manager-login-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Cards de login serão inseridos aqui pelo JS -->
            </div>
            
            <!-- Campos de senha e botão agora ocultos por padrão -->
            <div id="login-actions" class="mt-8 hidden transition-all duration-300 ease-in-out" style="opacity: 0; transform: translateY(10px);">
                <input type="password" id="manager-password-input" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite a sua senha...">
                <button id="manager-login-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm mt-3 h-4 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Tela Principal (Dashboard) -->
    <div id="dashboard" class="hidden container mx-auto p-4 md:p-8">
        
        <header class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
            <h1 id="dashboard-title" class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <div class="flex items-center gap-4">
                <input id="global-search-input" type="text" placeholder="Pesquisar em todas as amostras..." class="border-gray-300 rounded-lg shadow-sm text-sm p-2 w-full md:w-64">
                <!-- Sino de Notificação (será adicionado aqui) -->
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg text-sm hover:bg-red-600">Sair</button>
            </div>
        </header>

        <!-- Estado de Carregamento -->
        <div id="loading-state" class="hidden text-center p-12">
            <h2 class="text-2xl font-semibold text-gray-700">A carregar dados...</h2>
            <p id="loading-message" class="text-gray-500 mt-2">A processar amostras. Isto pode demorar um momento...</p>
        </div>

        <!-- Conteúdo do Dashboard -->
        <div id="dashboard-content" class="hidden">
            
            <!-- NOVO: Seção de Orientações (MOVIDA PARA O TOPO E ESTILIZADA) -->
            <section id="orientacoes-section" class="bg-blue-50 border border-blue-200 p-6 rounded-2xl mb-8"> <!-- Estilo alterado -->
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Como Usar este Painel</h2>
                <div class="text-gray-700 space-y-4 text-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-base mb-2 text-blue-800">Funcionalidades Principais</h3> <!-- Cor do título alterada -->
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Gráficos de Status:</strong> Os gráficos no topo mostram o status geral (Pendentes vs. Resolvidos) e a "Distribuição de Feedbacks" (Aprovadas, Reprovadas, etc.).</li>
                                <li><strong>Feed de Observações:</strong> Exibe as observações mais recentes dos vendedores do seu segmento. Use o filtro para ver um vendedor específico ou clique em "Responder" para enviar uma mensagem.</li>
                                <li><strong>Vendedores do Segmento:</strong> Lista todos os vendedores do seu segmento, o status das amostras (pendentes/total) e permite "Dar Baixa" nas amostras finalizadas.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-semibold text-base mb-2 text-blue-800">Análise e Interação</h3> <!-- Cor do título alterada -->
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Análise de Tipos de Feedback:</strong> Na seção inferior, clique em uma barra do gráfico (ex: "Preço Alto") para carregar instantaneamente todas as amostras com esse feedback na lista ao lado.</li>
                                <li><strong>Respostas Interativas:</strong> Você pode clicar em "Responder" em qualquer amostra, seja no Feed, no modal da "Distribuição de Feedbacks" ou na lista de "Análise de Tipos de Feedback".</li>
                                <li><strong>Sino de Notificação (Topo):</strong> O sino tocará e mostrará um número vermelho quando houver novas respostas de vendedores às suas mensagens.</li>
                                <li><strong>Pesquisa Global:</strong> Use a barra "Pesquisar em todas as amostras..." para encontrar amostras por nome de produto, cliente, vendedor, pedido ou observação. Pressione "Enter" para ver os resultados.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Fim da Seção de Orientações -->

            <!-- Gráficos -->
            <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Status (Amostras do Segmento)</h3>
                    <div style="height: 250px;"><canvas id="segment-status-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Distribuição de Feedbacks</h3>
                    <div style="height: 250px;"><canvas id="rejection-rate-chart"></canvas></div>
                </div>
            </section>

            <!-- Feeds Lado a Lado -->
            <section class="grid grid-cols-1 md:grid-cols-2 md:items-start gap-6 mb-10">
                
                <!-- Coluna Feed Observações -->
                <section>
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-3">
                        <h2 class="text-2xl font-bold text-gray-900">Feed de Observações</h2>
                        <select id="seller-feed-filter" class="border-gray-300 rounded-lg shadow-sm text-sm p-1 w-full sm:w-auto">
                            <option value="">Todos os Vendedores</option>
                            <!-- Opções adicionadas via JS -->
                        </select>
                    </div>
                    <div id="observations-feed-list" class="space-y-4 bg-white p-4 rounded-2xl shadow-sm border">
                        <p class="text-gray-500 placeholder-observation">Nenhuma observação encontrada.</p>
                    </div>
                </section>

                <!-- Coluna Vendedores do Segmento -->
                <section>
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-2xl font-bold text-gray-900">Vendedores do Segmento</h2>
                         <input id="seller-search-input" type="text" placeholder="Procurar vendedor..." class="border-gray-300 rounded-lg shadow-sm text-sm p-1">
                    </div>
                    <div id="sellers-list-container" class="bg-white rounded-2xl shadow-sm border">
                        <p class="text-gray-500 placeholder-seller p-4">Nenhum vendedor encontrado.</p>
                    </div>
                </section>
            </section>
            
            <!-- NOVO: Seção de Análise de Tipos de Feedback -->
            <section id="feedback-types-analysis-section" class="bg-white p-6 rounded-2xl shadow-sm border mb-10">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Análise de Tipos de Feedback</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Coluna do Gráfico -->
                    <div>
                        <h3 class="font-bold text-lg mb-2 text-center">Tipos de Feedback (Top 10)</h3>
                        <!-- O canvas que estava no topo agora está aqui -->
                        <div style="height: 400px;"><canvas id="feedback-types-chart"></canvas></div>
                    </div>
                    <!-- Coluna da Lista de Amostras -->
                    <div>
                        <h3 class="font-bold text-lg mb-2 text-center">Amostras Relacionadas</h3>
                        <p id="feedback-types-list-placeholder" class="text-gray-500 text-center mt-4 pt-16">Clique em uma barra do gráfico ao lado para ver as amostras relacionadas.</p>
                        <!-- Lista de amostras -->
                        <div id="feedback-types-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                            <!-- Amostras serão injetadas aqui via JS -->
                        </div>
                    </div>
                </div>
            </section>
            <!-- Fim da Nova Seção -->

            <!-- Tabela de Acessos (Admin) -->
            <section id="admin-access-section" class="hidden bg-white p-6 rounded-2xl shadow-sm border mb-10">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Acessos dos Gerentes (Admin)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Segmento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gerente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Senha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="manager-access-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Linhas inseridas pelo JS -->
                        </tbody>
                    </table>
                </div>
            </section>

        </div>
    </div>

    <!-- Modais -->
    
    <!-- Modal de Amostras (Genérico) -->
    <div id="feedback-samples-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="feedback-samples-title" class="text-xl font-bold">Amostras</h3>
                <button id="close-feedback-samples-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="feedback-samples-list" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                <p class="text-gray-500">A carregar detalhes...</p>
            </div>
        </div>
    </div>

    <!-- Modal de Resposta do Gerente -->
    <div id="reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
            <h3 class="text-xl font-bold mb-4">Responder ao Vendedor</h3>
            <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                <p class="font-semibold" id="reply-modal-product"></p>
                <p class="text-xs text-gray-600 mb-1" id="reply-modal-seller"></p>
                <p class="italic" id="reply-modal-observation">"${' '}"</p>
            </div>
            <div class="space-y-4">
                  <div>
                       <label for="reply-message-input" class="block text-sm font-medium text-gray-700">Sua Resposta (Gerente)</label>
                       <textarea id="reply-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua resposta aqui..."></textarea>
                       <p class="mt-2 text-xs text-gray-500">
                           <strong>Orientações:</strong>
                           <ul class="list-disc list-inside ml-2 mt-1">
                               <li>Seja claro e objetivo na sua resposta.</li>
                               <li>Esta mensagem será enviada ao vendedor.</li>
                               <li>Se a observação já foi tratada, informe o vendedor.</li>
                           </ul>
                       </p>
                  </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-reply-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                 <button id="send-reply-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar Resposta</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificações (Respostas dos Vendedores) -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold">Respostas de Vendedores</h3>
                <button id="close-notification-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="notification-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <p class="text-gray-500">Nenhuma resposta nova.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Customizado -->
    <div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-red-600">Erro na Operação</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6">Ocorreu um erro.</p>
            <div class="flex justify-end">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, getDocs, 
            updateDoc, query, orderBy, serverTimestamp, addDoc, limit, where,
            collectionGroup, Timestamp, runTransaction, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Definições de Acesso
        const MANAGER_PASSWORDS = {
            'CÁRNEOS': { name: 'LUIS ADRIANO', pass: 'carneospass123' },
            'LACTEOS': { name: 'VITOR MACHADO', pass: 'lacteospass456' },
            'NUTRICAO ANIMAL': { name: 'DANILO TREMOLCOLDI', pass: 'nutricaopass303' },
            'PANIFICACAO': { name: 'MARISTELA', pass: 'panificacaopass101' },
            'SMB': { name: 'GUSTAVO BONFIM', pass: 'smbpass202' },
            'SORVETES': { name: 'VINICIUS MADALENO', pass: 'sorvetespass789' },
            'ADMIN': { name: 'Admin', pass: 'admin123' } // Senha de Admin
        };
        const PENDING_STATUSES = ['EM ANÁLISE', 'AMOSTRA SEM FEEDBACK', 'SEM RETORNO DO CLIENTE', 'AMOSTRA NÃO TESTADA', 'PENDENTE'];
        
        // --- Elementos DOM ---
        const loginView = document.getElementById('login-view');
        const managerLoginButtons = document.getElementById('manager-login-buttons');
        const managerPasswordInput = document.getElementById('manager-password-input');
        const managerLoginBtn = document.getElementById('manager-login-btn');
        const loginError = document.getElementById('login-error');
        const dashboard = document.getElementById('dashboard');
        const loginActions = document.getElementById('login-actions'); 
        const dashboardTitle = document.getElementById('dashboard-title');
        const logoutBtn = document.getElementById('logout-btn');
        const globalSearchInput = document.getElementById('global-search-input');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const dashboardContent = document.getElementById('dashboard-content');
        const observationsFeedList = document.getElementById('observations-feed-list');
        const sellerFeedFilter = document.getElementById('seller-feed-filter'); 
        const sellersListContainer = document.getElementById('sellers-list-container');
        const sellerSearchInput = document.getElementById('seller-search-input');
        const adminAccessSection = document.getElementById('admin-access-section');
        const managerAccessTbody = document.getElementById('manager-access-tbody');
        const feedbackSamplesModal = document.getElementById('feedback-samples-modal');
        const feedbackSamplesTitle = document.getElementById('feedback-samples-title');
        const feedbackSamplesList = document.getElementById('feedback-samples-list');
        const closeFeedbackSamplesBtn = document.getElementById('close-feedback-samples-btn');
        // NOVO: Elementos da seção de análise
        const feedbackTypesList = document.getElementById('feedback-types-list');
        const feedbackTypesListPlaceholder = document.getElementById('feedback-types-list-placeholder');
        const replyModal = document.getElementById('reply-modal');
        const replyModalProduct = document.getElementById('reply-modal-product');
        const replyModalSeller = document.getElementById('reply-modal-seller');
        const replyModalObservation = document.getElementById('reply-modal-observation');
        const replyMessageInput = document.getElementById('reply-message-input');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const sendReplyBtn = document.getElementById('send-reply-btn');
        const notificationModal = document.getElementById('notification-modal');
        const notificationList = document.getElementById('notification-list');
        const closeNotificationBtn = document.getElementById('close-notification-btn');
        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        // --- Estado Global ---
        let currentSessionId = null;
        let currentSegment = null; // Segmento do Gerente logado
        let currentManagerName = null; // Nome do Gerente logado
        let allCurrentSamples = []; // Armazena TODAS as amostras carregadas
        let sellerSegmentsCache = {}; // Cache de segmentos de vendedores
        let sellerRepliesListenerUnsubscribe = null; // Respostas dos vendedores
        let managerRepliesListenerUnsubscribe = null; // Respostas dos gerentes (para P&D)
        let pdPostitsListenerUnsubscribe = null; // Notas P&D (para feed)
        let dataListenersUnsubscribe = [];
        let chartInstances = {};
        let currentSampleForReply = null;
        let allSellerReplies = []; // Respostas dos vendedores para o gerente
        let allManagerReplies = []; // Respostas dos gerentes para os vendedores (para o feed)
        let allPdPostits = []; // Post-its do P&D (para o feed)
        
        // Classe de Gestão de Carga
        class DataLoadManager {
            constructor(totalItems, onComplete) {
                this.totalItems = totalItems;
                this.loadedItems = 0;
                this.allData = [];
                this.onComplete = onComplete;
                this.hasCompleted = false;
            }

            sellerLoaded(sellerName, samples) {
                this.loadedItems++;
                const samplesWithOwner = samples.map(s => ({ ...s, sellerName }));
                this.allData = this.allData.concat(samplesWithOwner);
                
                const progress = this.totalItems > 0 ? (this.loadedItems / this.totalItems) * 100 : 100;
                loadingMessage.textContent = `A processar... (${this.loadedItems}/${this.totalItems} vendedores carregados)`;

                if (this.loadedItems === this.totalItems && !this.hasCompleted) {
                    this.hasCompleted = true;
                    this.onComplete(this.allData);
                }
            }
        }

        // --- Funções Utilitárias ---
        const normalizeText = (text = '') => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : '';

        function showAlert(message, title = "Erro na Operação", color = "text-red-600") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message; // Usar innerHTML para permitir <br>
            customAlertTitle.className = `text-xl font-bold mb-4 ${color}`;
            customAlert.classList.remove('hidden');
        }
        customAlertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

        function handleFirestoreError(error, operationContext) {
            console.error(`Erro em "${operationContext}":`, error);
            let message = `Não foi possível completar a operação: ${operationContext}.<br><br>Erro: ${error.message}`;
            let title = "Erro na Operação";
            let color = "text-red-600";

            if (error.code === 'resource-exhausted' || (error.message && error.message.includes('Quota exceeded'))) {
                message = "O limite diário de uso do banco de dados foi atingido (Quota Exceeded). Novas alterações não serão salvas hoje.<br><br>Por favor, tente novamente amanhã ou contate o suporte.";
                title = "Limite da Plataforma Atingido";
                color = "text-amber-600";
            } else if (error.code === 'permission-denied') {
                message = "Permissão negada. Verifique as regras de segurança do Firebase.";
            }
            showAlert(message, title, color);
        }

        // --- Lógica de Carregamento de Dados (v2) ---
        
        function listenForManagerReplies(sessionId) {
            if (managerRepliesListenerUnsubscribe) managerRepliesListenerUnsubscribe();
            const q = query(collection(db, "sessoes", sessionId, "notificacoesVendedor"));
            
            managerRepliesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 allManagerReplies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                     // NOVO: Atualiza a lista de análise se estiver visível
                     const currentSelectedBar = document.querySelector('#feedback-types-chart.active-bar-label');
                     if (currentSelectedBar) {
                         renderFeedbackSamplesForType(currentSelectedBar.dataset.label);
                     }
                 }
            }, (error) => handleFirestoreError(error, "ouvir respostas dos gestores (feed)"));
        }
        
        function listenForSellerRepliesFeed(sessionId) {
            const q = query(collection(db, "sessoes", sessionId, "respostasVendedor"));
            
            const unsub = onSnapshot(q, (snapshot) => {
                 allSellerReplies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                     // NOVO: Atualiza a lista de análise se estiver visível
                     const currentSelectedBar = document.querySelector('#feedback-types-chart.active-bar-label');
                     if (currentSelectedBar) {
                         renderFeedbackSamplesForType(currentSelectedBar.dataset.label);
                     }
                 }
            }, (error) => handleFirestoreError(error, "ouvir respostas dos vendedores (feed)"));
            dataListenersUnsubscribe.push(unsub);
        }

        function listenForPdPostits(sessionId) {
            if (pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();
            const q = query(collection(db, "sessoes", sessionId, "pdPostits"));
            
            pdPostitsListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 allPdPostits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (!dashboardContent.classList.contains('hidden')) {
                     renderObservationsFeed(allCurrentSamples);
                     // NOVO: Atualiza a lista de análise se estiver visível
                     const currentSelectedBar = document.querySelector('#feedback-types-chart.active-bar-label');
                     if (currentSelectedBar) {
                         renderFeedbackSamplesForType(currentSelectedBar.dataset.label);
                     }
                 }
            }, (error) => handleFirestoreError(error, "ouvir post-its P&D (feed)"));
        }

        function listenForSellerReplies(sessionId) {
            if (sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            const q = query(
                collection(db, "sessoes", sessionId, "respostasVendedor"),
                where("readByManager", "==", false)
            );
            
            sellerRepliesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                 renderNotificationBell(snapshot.docs.length);
            }, (error) => handleFirestoreError(error, "ouvir respostas de vendedores (notificação)"));
        }

        
        async function getActiveSessionId() {
            try {
                const activeSessionRef = doc(db, "configuracoes", "sessaoAtiva");
                const docSnap = await getDoc(activeSessionRef);
                if (docSnap.exists() && docSnap.data().current) {
                    return docSnap.data().current;
                } else {
                    return null;
                }
            } catch (error) {
                handleFirestoreError(error, "buscar sessão ativa");
                return null;
            }
        }

        async function loadSellerSegments() {
            sellerSegmentsCache = {};
            try {
                const segmentsSnap = await getDocs(collection(db, "vendedorConfig"));
                segmentsSnap.forEach(doc => {
                    sellerSegmentsCache[doc.id] = doc.data().segmento;
                });
            } catch (error) {
                handleFirestoreError(error, "carregar segmentos de vendedores");
            }
        }

        async function loadAllData(sessionId) {
            dashboard.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            loginView.classList.add('hidden');
            
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            
            currentSessionId = sessionId;
            allCurrentSamples = [];

            await loadSellerSegments();
            listenForSellerReplies(sessionId);
            listenForManagerReplies(sessionId);
            listenForSellerRepliesFeed(sessionId);
            listenForPdPostits(sessionId);

            const sellersQuery = query(collection(db, "sessoes", sessionId, "vendedores"));
            const sellersSnapshot = await getDocs(sellersQuery);
            const sellerDocs = sellersSnapshot.docs;
            
            if (sellerDocs.length === 0) {
                 loadingState.classList.add('hidden');
                 dashboardContent.classList.remove('hidden');
                 processAndDisplayDashboard([]);
                 return;
            }

            const loadManager = new DataLoadManager(sellerDocs.length, (allSamples) => {
                let filteredSamples;
                if (currentSegment === 'ADMIN') {
                    filteredSamples = allSamples;
                } else {
                    filteredSamples = allSamples.filter(sample => {
                        const sellerSegment = sellerSegmentsCache[normalizeText(sample.sellerName)];
                        return sellerSegment === currentSegment;
                    });
                }

                allCurrentSamples = filteredSamples; 
                processAndDisplayDashboard(allCurrentSamples); 
                
                loadingState.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
            });
            
            loadingMessage.textContent = `A preparar para carregar ${sellerDocs.length} vendedores...`;

            sellerDocs.forEach(sellerDoc => {
                const sellerData = sellerDoc.data();
                const samplesQuery = query(
                    collection(db, sellerDoc.ref.path, "amostras")
                );

                const unsub = onSnapshot(samplesQuery, (samplesSnapshot) => {
                    const samples = samplesSnapshot.docs.map(sampleDoc => ({
                        ...sampleDoc.data(),
                        id: sampleDoc.id,
                        sellerDocRef: sellerDoc.ref.path
                    }));
                    loadManager.sellerLoaded(sellerData.originalName, samples);
                }, (error) => {
                    handleFirestoreError(error, `ouvir amostras de ${sellerData.originalName}`);
                    loadManager.sellerLoaded(sellerData.originalName, []);
                });
                dataListenersUnsubscribe.push(unsub);
            });
        }

        // --- Lógica de Login ---
        
        function populateManagerButtons() {
            managerLoginButtons.innerHTML = '';

            Object.entries(MANAGER_PASSWORDS).forEach(([segment, data]) => {
                const card = document.createElement('button');
                card.className = "login-card";
                card.dataset.segment = segment;
                
                card.innerHTML = `
                    <div>
                        <p>${segment}</p>
                        <span class="login-card-name">${data.name}</span>
                    </div>
                    <svg class="w-5 h-5 opacity-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" />
                    </svg>
                `;
                
                card.addEventListener('click', () => {
                    managerLoginButtons.querySelectorAll('.login-card').forEach(c => {
                        c.classList.remove('selected');
                        c.querySelector('svg:last-child').classList.add('opacity-0');
                    });
                    card.classList.add('selected');
                    card.querySelector('svg:last-child').classList.remove('opacity-0');
                    currentSegment = segment;
                    currentManagerName = data.name;

                    // Mostrar o campo de senha ao clicar
                    loginActions.classList.remove('hidden');
                    setTimeout(() => {
                        loginActions.style.opacity = '1';
                        loginActions.style.transform = 'translateY(0)';
                    }, 10); 
                });
                managerLoginButtons.appendChild(card);
            });
        }

        async function login() {
            const password = managerPasswordInput.value;
            if (!currentSegment) {
                loginError.textContent = 'Por favor, selecione o seu segmento.';
                return;
            }
            
            if (MANAGER_PASSWORDS[currentSegment].pass === password) {
                loginError.textContent = '';
                managerLoginBtn.disabled = true;
                managerLoginBtn.textContent = 'A carregar...';

                localStorage.setItem('managerSegment', currentSegment); 
                
                const sessionId = await getActiveSessionId();
                if (!sessionId) {
                    loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                    managerLoginBtn.disabled = false;
                    managerLoginBtn.textContent = 'Entrar';
                    return;
                }
                
                dashboardTitle.textContent = `Painel Gerente: ${currentSegment}`;
                if (currentSegment === 'ADMIN') {
                    adminAccessSection.classList.remove('hidden');
                    renderAccessTable();
                }
                
                await loadAllData(sessionId);

            } else {
                loginError.textContent = 'Senha incorreta.';
            }
        }
        
        function logout() {
            localStorage.removeItem('managerSegment');
            currentSessionId = null;
            currentSegment = null;
            currentManagerName = null;
            allCurrentSamples = [];
            allManagerReplies = [];
            allSellerReplies = [];
            allPdPostits = [];
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            if(sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            if(managerRepliesListenerUnsubscribe) managerRepliesListenerUnsubscribe();
            if(pdPostitsListenerUnsubscribe) pdPostitsListenerUnsubscribe();
            
            dashboard.classList.add('hidden');
            loginView.classList.remove('hidden');
            managerPasswordInput.value = '';
            managerLoginBtn.disabled = false;
            managerLoginBtn.textContent = 'Entrar';
            adminAccessSection.classList.add('hidden');
            managerLoginButtons.querySelectorAll('.login-card').forEach(c => {
                 c.classList.remove('selected');
                 c.querySelector('svg:last-child').classList.add('opacity-0');
            });
            
            // Ocultar campos de login ao sair
            loginActions.classList.add('hidden');
            loginActions.style.opacity = '0';
            loginActions.style.transform = 'translateY(10px)';

            // Remove o sino
            document.getElementById('notification-btn')?.parentElement.remove();
        }

        // --- Processamento e Renderização do Dashboard ---
        function processAndDisplayDashboard(samples) {
            if (!samples) return;
            renderCharts(samples);
            renderFeedbackTypesChart(samples); 
            renderObservationsFeed(samples);
            renderSellersList(samples);
            populateSellerFeedFilter(samples); 
        }

        function populateSellerFeedFilter(samples) {
            const sellerNames = [...new Set(samples.map(s => s.sellerName))].sort();
            sellerFeedFilter.innerHTML = '<option value="">Todos os Vendedores</option>';
            sellerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                sellerFeedFilter.appendChild(option);
            });
        }

        function renderCharts(samples) {
            let pending = 0, resolved = 0, approved = 0, rejected = 0, events = 0;
            const APPROVED_PREFIX = 'A -';
            const REJECTED_PREFIX = 'R -';
            const EVENTS_PREFIX = 'E -';

            samples.forEach(s => {
                if (s.isPending) {
                    pending++;
                } else {
                    resolved++;
                    const feedback = s.feedback || '';
                    if (feedback.startsWith(APPROVED_PREFIX)) approved++;
                    else if (feedback.startsWith(REJECTED_PREFIX)) rejected++;
                    else if (feedback.startsWith(EVENTS_PREFIX)) events++;
                }
            });

            const statusTitle = document.querySelector('#segment-status-chart').closest('.bg-white').querySelector('h3');
            if (currentSegment !== 'ADMIN') {
                 statusTitle.textContent = "Status (Amostras do Segmento)";
            }

            renderChart('segment-status-chart', 'doughnut', {
                labels: ['Pendentes', 'Resolvidos'],
                datasets: [{ data: [pending, resolved], backgroundColor: ['#facc15', '#3b82f6'] }]
            });

            if (approved === 0 && rejected === 0 && events === 0 && resolved > 0) {
                 renderChart('rejection-rate-chart', 'doughnut', { labels: ['Aguardando Feedbacks'], datasets: [{ data: [resolved], backgroundColor: ['#e5e7eb'] }] });
            } else if (approved === 0 && rejected === 0 && events === 0) {
                 renderChart('rejection-rate-chart', 'doughnut', { labels: ['Aguardando Respostas'], datasets: [{ data: [1], backgroundColor: ['#e5e7eb'] }] });
            } else {
                renderChart('rejection-rate-chart', 'doughnut', {
                    labels: ['Aprovadas', 'Reprovadas', 'Eventos'],
                    datasets: [{
                        data: [approved, rejected, events],
                        backgroundColor: ['#34d399', '#f87171', '#a78bfa']
                    }]
                });
            }
        }

        function renderFeedbackTypesChart(samples) {
            const feedbackCounts = {};
            const prefixes = ['A -', 'R -', 'E -'];

            samples.forEach(s => {
                if (s.feedback && !s.isPending) {
                    let feedbackReason = s.feedback;
                    for (const prefix of prefixes) {
                        if (feedbackReason.startsWith(prefix)) {
                            feedbackReason = feedbackReason.substring(prefix.length).trim();
                            break;
                        }
                    }
                    if (feedbackReason && feedbackReason.toUpperCase() !== 'APROVADO' && feedbackReason.toUpperCase() !== 'REPROVADO') {
                         feedbackCounts[feedbackReason] = (feedbackCounts[feedbackReason] || 0) + 1;
                    }
                }
            });

            const sortedFeedbacks = Object.entries(feedbackCounts)
                .sort(([,a],[,b]) => b - a)
                .slice(0, 10);

            const labels = sortedFeedbacks.map(([label]) => label);
            const data = sortedFeedbacks.map(([, count]) => count);

            if (labels.length === 0) {
                 renderChart('feedback-types-chart', 'bar', {
                    labels: ['Nenhuma razão específica encontrada'],
                    datasets: [{ label: 'Contagem', data: [0], backgroundColor: ['#e5e7eb'] }]
                }, { plugins: { legend: { display: false } } });
                return;
            }

            renderChart('feedback-types-chart', 'bar', {
                labels: labels,
                datasets: [{
                    label: 'Contagem',
                    data: data,
                    backgroundColor: '#60a5fa' // bg-blue-400
                }]
            }, {
                indexAxis: 'y', 
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0 
                        }
                    }
                },
                // NOVO: onClick handler para este gráfico
                onClick: (event, elements) => {
                    const canvas = document.getElementById('feedback-types-chart');
                    if (elements.length > 0) {
                        const chart = chartInstances['feedback-types-chart'];
                        const elementIndex = elements[0].index;
                        const label = chart.data.labels[elementIndex];
                        renderFeedbackSamplesForType(label); // Chama a nova função
                        
                        // Guarda a label clicada para atualizações em tempo real
                        canvas.dataset.activeLabel = label; 
                    }
                },
                onHover: (event, chartElement) => {
                    if (event.native) {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }

        function renderChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            
            let chartSpecificOptions = { ...options };

            // O onClick do rejection-rate-chart (Distribuição) continua abrindo o MODAL
            if (canvasId === 'rejection-rate-chart') {
                chartSpecificOptions.onClick = (event, elements) => {
                    if (elements.length > 0) {
                        const chart = chartInstances[canvasId];
                        const elementIndex = elements[0].index;
                        const label = chart.data.labels[elementIndex];
                        showSamplesForFeedback(label); // Abre o MODAL
                    }
                };
                chartSpecificOptions.onHover = (event, chartElement) => {
                    if (event.native) {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                };
            }
            
            Chart.register(ChartDataLabels);
            chartInstances[canvasId] = new Chart(ctx, { 
                type, 
                data, 
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type === 'doughnut' },
                        datalabels: { display: false },
                        ...options.plugins
                    },
                    ...chartSpecificOptions 
                }
            });
        }
        
        // NOVO: Função para renderizar amostras na seção de análise
        function renderFeedbackSamplesForType(feedbackLabel) {
            if (!feedbackLabel) {
                feedbackTypesList.innerHTML = '';
                feedbackTypesListPlaceholder.textContent = 'Nenhuma razão de feedback selecionada.';
                feedbackTypesListPlaceholder.classList.remove('hidden');
                return;
            }

            const prefixes = ['A -', 'R -', 'E -'];
            const filteredSamples = allCurrentSamples.filter(s => {
                if (s.feedback && !s.isPending) {
                    let feedbackReason = s.feedback;
                    for (const prefix of prefixes) {
                        if (feedbackReason.startsWith(prefix)) {
                            feedbackReason = feedbackReason.substring(prefix.length).trim();
                            break;
                        }
                    }
                    return feedbackReason === feedbackLabel;
                }
                return false;
            }).sort((a, b) => (b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0) - (a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0));

            feedbackTypesList.innerHTML = ''; // Limpa a lista
            
            if (filteredSamples.length === 0) {
                feedbackTypesListPlaceholder.textContent = `Nenhuma amostra encontrada para "${feedbackLabel}".`;
                feedbackTypesListPlaceholder.classList.remove('hidden');
                return;
            }

            feedbackTypesListPlaceholder.classList.add('hidden'); // Oculta o placeholder

            filteredSamples.forEach(sample => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `feedback-sample-item text-sm`; // Reutiliza a classe do modal
                
                // Lógica de replies (copiada de openSamplesModal)
                let repliesHtml = '';
                const pdNote = allPdPostits.find(p => p.contextId === sample.id);
                if (pdNote) repliesHtml += `<div class="pd-note"><p><strong>Nota P&D:</strong> ${pdNote.message}</p></div>`;
                
                const managerReply = allManagerReplies.find(r => r.sellerName === sample.sellerName && r.pedido === sample.pedido && r.produto === sample.produto && r.originalObservation === sample.observation);
                if (managerReply) {
                    // CORREÇÃO: Usar replyMessage
                    repliesHtml += `<div class="manager-reply"><p><strong>${managerReply.managerName}:</strong> ${managerReply.replyMessage}</p></div>`; 
                    const sellerReply = allSellerReplies.find(r => r.originalManagerMessage === managerReply.replyMessage && r.pedido === sample.pedido);
                    if (sellerReply) repliesHtml += `<div class="seller-reply"><p><strong>${sellerReply.sellerName}:</strong> ${sellerReply.replyMessage}</p></div>`;
                }

                // Botão de resposta (copiado de openSamplesModal)
                const replyButtonHtml = `
                    <button class="reply-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                        Responder
                    </button>
                `;

                // HTML do item (copiado de openSamplesModal)
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold">${sample.produto} (${sample.razaoSocial})</p>
                            <p class="text-xs text-gray-600">${sample.descricao}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                Vendedor: ${sample.sellerName} | Pedido: ${sample.pedido} | NF: ${sample.emissaoNF || 'N/A'}
                            </p>
                            <p class="font-medium text-gray-800 mt-1">Feedback: ${sample.feedback}</p>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            ${sample.observation ? replyButtonHtml : ''}
                        </div>
                    </div>
                    ${sample.observation ? `<p class="text-xs text-gray-600 mt-1 italic">Obs: ${sample.observation}</p>` : ''}
                    ${repliesHtml}
                `;
                feedbackTypesList.appendChild(itemDiv);
            });
            // Listeners serão adicionados por delegação
        }

        function renderObservationsFeed(samples) {
            const globalSearch = normalizeText(globalSearchInput.value);
            const sellerFilter = sellerFeedFilter.value; 

            const filteredSamples = samples.filter(s => {
                if (!s.observation) return false;
                if (sellerFilter && s.sellerName !== sellerFilter) {
                    return false;
                }
                if (globalSearch) {
                    return (
                        normalizeText(s.sellerName).includes(globalSearch) ||
                        normalizeText(s.produto).includes(globalSearch) ||
                        normalizeText(s.descricao).includes(globalSearch) ||
                        normalizeText(s.razaoSocial).includes(globalSearch) ||
                        normalizeText(s.observation).includes(globalSearch) ||
                        normalizeText(s.pedido).includes(globalSearch)
                    );
                }
                return true;
            }).sort((a, b) => (b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0) - (a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0));
            
            observationsFeedList.innerHTML = '';
            if (filteredSamples.length === 0) {
                 let msg = 'Nenhuma observação encontrada.';
                 if (globalSearch) msg = 'Nenhum resultado para a pesquisa.';
                 else if (sellerFilter) msg = 'Nenhuma observação para este vendedor.';
                 
                 observationsFeedList.innerHTML = `<p class="text-gray-500 placeholder-observation p-4">${msg}</p>`;
                 return;
            }
            
            filteredSamples.forEach(sample => {
                 const card = document.createElement('div');
                 card.className = "p-4 border-b border-gray-100 last:border-b-0";
                 const time = sample.lastUpdate?.toDate() ? sample.lastUpdate.toDate().toLocaleString('pt-BR') : 'data inválida';
                 
                 let repliesHtml = '';
                 
                 const pdNote = allPdPostits.find(p => p.contextId === sample.id);
                 if (pdNote) {
                      repliesHtml += `
                         <div class="pd-note">
                             <p><strong>Nota P&D (${pdNote.pdManagerName}):</strong> ${pdNote.message}</p>
                         </div>
                     `;
                 }
                 
                 const managerReply = allManagerReplies
                    .filter(r => r.sellerName === sample.sellerName && r.pedido === sample.pedido && r.produto === sample.produto && r.originalObservation === sample.observation)
                    .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0];
                 
                 if (managerReply) {
                     const isPD = managerReply.managerName.includes('P&D');
                     repliesHtml += `
                         <div class="${isPD ? 'pd-note' : 'manager-reply'}">
                             <p><strong>${managerReply.managerName} respondeu:</strong> ${managerReply.replyMessage}</p>
                         </div>
                     `;
                     
                     const sellerReply = allSellerReplies
                        .filter(r => r.originalManagerMessage === managerReply.replyMessage && r.pedido === sample.pedido && r.produto === sample.produto)
                        .sort((a, b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0))[0];
                     
                     if (sellerReply) {
                         repliesHtml += `
                             <div class="seller-reply">
                                 <p><strong>${sellerReply.sellerName} (Vendedor) respondeu:</strong> ${sellerReply.replyMessage}</p>
                             </div>
                         `;
                     }
                 }

                 let feedbackHtml = '';
                 if (sample.feedback && !sample.isPending) {
                    let color = 'text-gray-600';
                    if (sample.feedback.startsWith('A -')) color = 'text-green-600';
                    else if (sample.feedback.startsWith('R -')) color = 'text-red-600';
                    else if (sample.feedback.startsWith('E -')) color = 'text-purple-600';
                    feedbackHtml = `<p class="font-semibold ${color} mt-1">Feedback: ${sample.feedback}</p>`;
                 }
                 
                 card.innerHTML = `
                    <div class="mb-2">
                        <p class="font-bold text-gray-800">${sample.produto}</p>
                        <p class="text-sm text-gray-600">${sample.descricao || 'Sem descrição'}</p>
                        <p class="text-xs text-gray-500">${sample.razaoSocial || 'Cliente N/A'}</p>
                        ${feedbackHtml} 
                    </div>
                    <p class="text-gray-700 mb-3 italic">"${sample.observation}"</p>
                    
                    ${repliesHtml}

                    <div class="flex justify-between items-end text-xs text-gray-500 mt-3 pt-3 border-t">
                         <div>
                             <p>- ${sample.sellerName} (Pedido: ${sample.pedido})</p>
                             <p class="text-gray-400">Obs.: ${time}</p>
                         </div>
                         <div class="flex gap-2">
                             <button class="reply-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                                 Responder
                             </button>
                         </div>
                    </div>
                 `;
                 observationsFeedList.appendChild(card);
            });
            
            observationsFeedList.querySelectorAll('.reply-btn').forEach(btn => {
                 btn.addEventListener('click', openReplyModal);
            });
        }
        
        function renderSellersList(samples) {
            const searchTerm = normalizeText(sellerSearchInput.value);
            
            const sellers = samples.reduce((acc, sample) => {
                if (!acc[sample.sellerName]) {
                    acc[sample.sellerName] = {
                        name: sample.sellerName,
                        total: 0,
                        pending: 0,
                        finalizedByVendor: true,
                        systemStatus: 'baixado'
                    };
                }
                acc[sample.sellerName].total++;
                if (sample.isPending) {
                    acc[sample.sellerName].pending++;
                    acc[sample.sellerName].finalizedByVendor = false;
                }
                if (sample.systemStatus !== 'baixado') {
                    acc[sample.sellerName].systemStatus = 'pending';
                }
                return acc;
            }, {});

            const filteredSellers = Object.values(sellers).filter(seller => {
                 if (searchTerm) {
                     return normalizeText(seller.name).includes(searchTerm);
                 }
                 return true;
            }).sort((a, b) => a.name.localeCompare(b.name));

            sellersListContainer.innerHTML = ''; 
            if (filteredSellers.length === 0) {
                 const msg = searchTerm ? 'Nenhum vendedor encontrado.' : 'Nenhum vendedor neste segmento.';
                 sellersListContainer.innerHTML = `<p class="text-gray-500 placeholder-seller p-4">${msg}</p>`;
                 return;
            }

            filteredSellers.forEach(seller => {
                const item = document.createElement('div');
                
                let statusColor = 'yellow'; 
                let statusHTML = `<span class="text-xs text-gray-500">${seller.pending} pendente(s)</span>`;

                if (seller.finalizedByVendor && seller.systemStatus === 'pending') {
                    statusColor = 'green';
                    statusHTML = `
                         <label class="flex items-center space-x-2 cursor-pointer text-sm">
                             <input type="checkbox" class="system-check-btn rounded" data-seller-name="${seller.name}">
                             <span class="text-xs">Dar Baixa</span>
                         </label>`;
                } else if (seller.systemStatus === 'baixado') {
                    statusColor = 'purple';
                    statusHTML = `<span class="text-sm font-semibold text-purple-600">✓ Baixado</span>`;
                }

                item.className = `flex justify-between items-center p-3 border-b border-gray-100 last:border-b-0`;
                item.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-${statusColor}-500 flex-shrink-0"></span>
                        <span class="font-medium text-sm text-gray-800">${seller.name}</span>
                    </div>
                    <div class="text-xs text-right flex-shrink-0 ml-2">
                        ${statusHTML}
                        <span class="text-gray-400 ml-1">(${seller.pending}/${seller.total})</span>
                    </div>`;
                
                sellersListContainer.appendChild(item);
            });

            sellersListContainer.querySelectorAll('.system-check-btn').forEach(checkbox => {
                 checkbox.addEventListener('change', (e) => darBaixaVendedor(e, checkbox.dataset.sellerName));
            });
        }
        
        async function darBaixaVendedor(event, sellerName) {
            const checkbox = event.target;
            if (!checkbox.checked) return; 
            
            checkbox.disabled = true;
            const originalLabel = checkbox.parentElement.querySelector('span');
            originalLabel.textContent = 'A guardar...';
            
            try {
                const normalizedSellerName = normalizeText(sellerName);
                const sellerSessionRef = doc(db, "sessoes", currentSessionId, "vendedores", normalizedSellerName);
                
                const samplesToUpdateQuery = query(
                    collection(db, sellerSessionRef.path, "amostras"),
                    where("isPending", "==", false),
                    where("systemStatus", "==", "pending")
                );
                
                const samplesSnapshot = await getDocs(samplesToUpdateQuery);
                
                if (samplesSnapshot.empty) {
                     showAlert("Nenhuma amostra finalizada encontrada para este vendedor.", "Aviso", "text-amber-600");
                } else {
                    const batch = writeBatch(db);
                    samplesSnapshot.forEach(sampleDoc => {
                        batch.update(sampleDoc.ref, { systemStatus: 'baixado' });
                    });
                    await batch.commit();
                }
                
            } catch(error) {
                 handleFirestoreError(error, `dar baixa para ${sellerName}`);
                 checkbox.disabled = false;
                 checkbox.checked = false;
                 originalLabel.textContent = 'Dar Baixa';
            }
        }
        
        function renderAccessTable() {
             managerAccessTbody.innerHTML = '';
             Object.entries(MANAGER_PASSWORDS).forEach(([segment, data]) => {
                 if(segment === 'ADMIN') return;
                 const row = document.createElement('tr');
                 row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${segment}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 password-cell" data-password="${data.pass}">••••••</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="toggle-password-btn text-blue-600 hover:text-blue-800" data-state="hidden">Visualizar</button>
                    </td>
                 `;
                 managerAccessTbody.appendChild(row);
             });
        }

        // --- Lógica de Resposta e Notificação ---
        
        function openReplyModal(e) {
             // CORREÇÃO: Achar o botão clicado, seja ele o target ou o currentTarget
             const button = e.target.closest('.reply-btn') || e.currentTarget;
             const sampleId = button.dataset.sampleId;
             currentSampleForReply = allCurrentSamples.find(s => s.id === sampleId);
             
             if (!currentSampleForReply) {
                console.error("Amostra não encontrada. ID:", sampleId, "Evento:", e);
                return showAlert("Erro: Amostra não encontrada.");
             }
             
             replyModalProduct.textContent = `${currentSampleForReply.produto} (${currentSampleForReply.pedido})`;
             replyModalSeller.textContent = `Observação de: ${currentSampleForReply.sellerName}`;
             replyModalObservation.textContent = `"${currentSampleForReply.observation}"`;
             replyMessageInput.value = '';
             replyModal.classList.remove('hidden');
        }

        async function sendReplyToManager() {
            if (!currentSampleForReply || !currentSessionId) return;
            
            const replyMessage = replyMessageInput.value.trim();
            if (!replyMessage || !currentManagerName) {
                return showAlert("A mensagem de resposta não pode estar vazia.");
            }

            sendReplyBtn.disabled = true;
            sendReplyBtn.textContent = 'A Enviar...';

            try {
                const notificationData = {
                    managerName: currentManagerName,
                    replyMessage: replyMessage,
                    originalObservation: currentSampleForReply.observation,
                    sellerName: currentSampleForReply.sellerName,
                    pedido: currentSampleForReply.pedido,
                    produto: currentSampleForReply.produto,
                    razaoSocial: currentSampleForReply.razaoSocial || '',
                    descricao: currentSampleForReply.descricao || '',
                    timestamp: serverTimestamp(),
                    read: false,
                    readByPd: false
                };

                const sellerNotifsRef = collection(db, "sessoes", currentSessionId, "notificacoesVendedor");
                await addDoc(sellerNotifsRef, notificationData);

                replyModal.classList.add('hidden');
                showAlert("Resposta enviada com sucesso.", "Sucesso", "text-green-600");
                
            } catch (error) {
                handleFirestoreError(error, "enviar resposta ao vendedor");
            } finally {
                sendReplyBtn.disabled = false;
                sendReplyBtn.textContent = 'Enviar Resposta';
                currentSampleForReply = null;
            }
        }
        
        let bellBtn = null; 
        function renderNotificationBell(unreadCount) {
             let countBadge = document.getElementById('notification-count-badge');
             
             if (!bellBtn) {
                const header = document.querySelector('#dashboard header .flex.items-center.gap-4');
                if (!header) return; 
                const bellWrapper = document.createElement('div');
                bellWrapper.className = "relative";
                bellWrapper.innerHTML = `
                    <button id="notification-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-count-badge" class="hidden absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">0</span>
                    </button>
                `;
                header.insertBefore(bellWrapper, logoutBtn);
                bellBtn = document.getElementById('notification-btn');
                countBadge = document.getElementById('notification-count-badge');
                
                bellBtn.addEventListener('click', openNotificationModal);
             }
             
             if (unreadCount > 0) {
                 countBadge.textContent = unreadCount;
                 countBadge.classList.remove('hidden');
             } else {
                 countBadge.classList.add('hidden');
             }
        }
        
        async function openNotificationModal() {
             notificationList.innerHTML = '';
             
             const q = query(
                collection(db, "sessoes", currentSessionId, "respostasVendedor"),
                where("readByManager", "==", false),
                orderBy("timestamp", "desc")
             );
             
             const snapshot = await getDocs(q);
             const replies = snapshot.docs;

             if (replies.length === 0) {
                 notificationList.innerHTML = '<p class="text-gray-500">Nenhuma resposta nova.</p>';
                 notificationModal.classList.remove('hidden');
                 return;
             }
             
             const batch = writeBatch(db);
             
             replies.forEach(replyDoc => {
                 const reply = replyDoc.data();
                 const item = document.createElement('div');
                 item.className = "p-3 border-b border-gray-100";
                 item.innerHTML = `
                    <p><span class="font-semibold text-green-600">${reply.sellerName}</span> (Vendedor) respondeu:</p>
                    <p class="italic text-gray-700 my-1">"${reply.replyMessage}"</p>
                    <p class="text-xs text-gray-500">Ref: ${reply.produto} (Pedido: ${reply.pedido})</p>
                    <p class="text-xs text-gray-400">Mensagem original: "${reply.originalManagerMessage}"</p>
                 `;
                 notificationList.appendChild(item);
                 
                 batch.update(replyDoc.ref, { readByManager: true });
             });
             
             notificationModal.classList.remove('hidden');
             await batch.commit();
        }
        
        // --- Modal de Amostras (Genérico) ---
        function openSamplesModal(samples, title) {
            feedbackSamplesTitle.textContent = title;
            feedbackSamplesList.innerHTML = '';
            
            if (samples.length === 0) {
                 feedbackSamplesList.innerHTML = '<p class="text-gray-500">Nenhum resultado encontrado.</p>';
                 feedbackSamplesModal.classList.remove('hidden');
                 return;
            }
            
            samples.forEach(sample => {
                 const itemDiv = document.createElement('div');
                 itemDiv.className = `feedback-sample-item text-sm`;
                 
                 let repliesHtml = '';
                 const pdNote = allPdPostits.find(p => p.contextId === sample.id);
                 if (pdNote) repliesHtml += `<div class="pd-note"><p><strong>Nota P&D:</strong> ${pdNote.message}</p></div>`;
                 
                 const managerReply = allManagerReplies.find(r => r.sellerName === sample.sellerName && r.pedido === sample.pedido && r.produto === sample.produto && r.originalObservation === sample.observation);
                 if (managerReply) {
                    // CORREÇÃO: Usar replyMessage
                     repliesHtml += `<div class="manager-reply"><p><strong>${managerReply.managerName}:</strong> ${managerReply.replyMessage}</p></div>`;
                     const sellerReply = allSellerReplies.find(r => r.originalManagerMessage === managerReply.replyMessage && r.pedido === sample.pedido);
                     if (sellerReply) repliesHtml += `<div class="seller-reply"><p><strong>${sellerReply.sellerName}:</strong> ${sellerReply.replyMessage}</p></div>`;
                 }

                 const replyButtonHtml = `
                     <button class="reply-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                         Responder
                     </button>
                 `;

                 itemDiv.innerHTML = `
                     <div class="flex justify-between items-start">
                         <div>
                             <p class="font-semibold">${sample.produto} (${sample.razaoSocial})</p>
                             <p class="text-xs text-gray-600">${sample.descricao}</p>
                             <p class="text-xs text-gray-500 mt-1">
                                 Vendedor: ${sample.sellerName} | Pedido: ${sample.pedido} | NF: ${sample.emissaoNF || 'N/A'}
                             </p>
                             <p class="font-medium text-gray-800 mt-1">Feedback: ${sample.feedback || 'Pendente'}</p>
                         </div>
                         <div class="flex-shrink-0 ml-4">
                            ${sample.observation ? replyButtonHtml : ''}
                         </div>
                     </div>
                     ${sample.observation ? `<p class="text-xs text-gray-600 mt-1 italic">Obs: ${sample.observation}</p>` : ''}
                     ${repliesHtml}
                 `;
                 feedbackSamplesList.appendChild(itemDiv);
            });
            
            // Listeners agora são por delegação (ver abaixo)
            feedbackSamplesModal.classList.remove('hidden');
        }

        // Função para cliques no gráfico de feedback (Índice)
        function showSamplesForFeedback(feedbackType) {
            if (!feedbackType) return;

            const APPROVED_PREFIX = 'A -';
            const REJECTED_PREFIX = 'R -';
            const EVENTS_PREFIX = 'E -';
            let filteredSamples = [];

            if (feedbackType.includes('Aprovadas')) {
                filteredSamples = allCurrentSamples.filter(s => s.feedback && s.feedback.startsWith(APPROVED_PREFIX));
            } else if (feedbackType.includes('Reprovadas')) {
                filteredSamples = allCurrentSamples.filter(s => s.feedback && s.feedback.startsWith(REJECTED_PREFIX));
            } else if (feedbackType.includes('Eventos')) {
                filteredSamples = allCurrentSamples.filter(s => s.feedback && s.feedback.startsWith(EVENTS_PREFIX));
            } else {
                return; 
            }

            openSamplesModal(filteredSamples, `Amostras: ${feedbackType} (${filteredSamples.length})`);
        }


        // --- Event Listeners Globais ---
        managerLoginBtn.addEventListener('click', login);
        logoutBtn.addEventListener('click', logout);
        sellerSearchInput.addEventListener('input', () => renderSellersList(allCurrentSamples));
        
        sellerFeedFilter.addEventListener('change', () => renderObservationsFeed(allCurrentSamples));

        globalSearchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = normalizeText(globalSearchInput.value);
                if (!searchTerm) {
                    renderObservationsFeed(allCurrentSamples);
                    return;
                }
                const filteredSamples = allCurrentSamples.filter(s => 
                    normalizeText(s.sellerName).includes(searchTerm) ||
                    normalizeText(s.produto).includes(searchTerm) ||
                    normalizeText(s.descricao).includes(searchTerm) ||
                    normalizeText(s.razaoSocial).includes(searchTerm) ||
                    (s.observation && normalizeText(s.observation).includes(searchTerm)) ||
                    normalizeText(s.pedido).includes(searchTerm)
                ).sort((a, b) => (b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0) - (a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0));
                
                openSamplesModal(filteredSamples, `Resultados da Pesquisa: "${globalSearchInput.value}" (${filteredSamples.length})`);
                
            } else { 
                renderObservationsFeed(allCurrentSamples);
            }
        });

        // Modais
        closeFeedbackSamplesBtn.addEventListener('click', () => feedbackSamplesModal.classList.add('hidden'));
        cancelReplyBtn.addEventListener('click', () => replyModal.classList.add('hidden'));
        sendReplyBtn.addEventListener('click', sendReplyToManager);
        
        closeNotificationBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));
        
        // NOVO: Delegação de evento para a lista do modal de amostras
        feedbackSamplesList.addEventListener('click', (e) => {
            const button = e.target.closest('.reply-btn');
            if (button) {
                // Abre o modal de resposta
                openReplyModal(e);
                // Fecha o modal atual (de amostras)
                feedbackSamplesModal.classList.add('hidden');
            }
        });

        // NOVO: Delegação de evento para a lista de análise de feedback
        feedbackTypesList.addEventListener('click', (e) => {
            const button = e.target.closest('.reply-btn');
            if (button) {
                openReplyModal(e); 
                // Não precisa fechar modal, pois não está em um
            }
        });

        managerAccessTbody.addEventListener('click', (e) => {
            const button = e.target.closest('.toggle-password-btn');
            if (button) {
                const cell = button.closest('tr').querySelector('.password-cell');
                const password = cell.dataset.password;

                if (button.dataset.state === 'hidden') {
                    cell.textContent = password;
                    button.textContent = 'Ocultar';
                    button.dataset.state = 'visible';
                } else {
                    cell.textContent = '••••••';
                    button.textContent = 'Visualizar';
                    button.dataset.state = 'hidden';
                }
            }
        });

        // --- INICIALIZAÇÃO ---
        (async () => {
            try {
                await signInAnonymously(auth); 
                populateManagerButtons(); 
                
                const savedSegment = localStorage.getItem('managerSegment');
                if (savedSegment && MANAGER_PASSWORDS[savedSegment]) {
                    currentSegment = savedSegment;
                    currentManagerName = MANAGER_PASSWORDS[savedSegment].name;
                    managerLoginBtn.disabled = true;
                    managerLoginBtn.textContent = 'A carregar...';
                    
                    managerLoginButtons.querySelectorAll('.login-card').forEach(c => {
                         if(c.dataset.segment === savedSegment) {
                             c.classList.add('selected');
                             c.querySelector('svg:last-child').classList.remove('opacity-0');
                         }
                    });

                    // Mostra campos de login se estiver salvo (para login automático)
                    loginActions.classList.remove('hidden');
                    loginActions.style.opacity = '1';
                    loginActions.style.transform = 'translateY(0)';
                    
                    const sessionId = await getActiveSessionId();
                    if (!sessionId) {
                        loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                        logout();
                        return;
                    }
                    
                    dashboardTitle.textContent = `Painel Gerente: ${currentSegment}`;
                    if (currentSegment === 'ADMIN') {
                        adminAccessSection.classList.remove('hidden');
                        renderAccessTable();
                    }
                    
                    await loadAllData(sessionId);
                }

            } catch (error) {
                console.error("Firebase Auth Error:", error);
                document.body.innerHTML = '<p class="text-center text-red-500 p-8">Erro crítico ao conectar com o Firebase. Verifique a configuração.</p>';
            }
        })();

    </script>
</body>
</html>































