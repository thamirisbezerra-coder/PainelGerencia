<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gerentes (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .seller-list-container {
            max-height: 448px; /* 28rem, mesma altura do feed de observações */
            overflow-y: auto;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .manager-reply, .seller-reply {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        .manager-reply {
            background-color: #f3f4f6; /* bg-gray-100 */
            border-left: 3px solid #9ca3af; /* border-gray-400 */
        }
        .seller-reply {
            background-color: #f0f9ff; /* bg-blue-50 */
            border-left: 3px solid #60a5fa; /* border-blue-400 */
            margin-left: 1rem; /* Indent seller reply */
        }
        .feedback-sample-item {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .feedback-sample-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .feedback-sample-item.highlight {
            background-color: #fffbeb; /* bg-amber-50 */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Tela de Login -->
    <div id="login-view" class="grid place-items-center min-h-screen p-4">
        <div class_ ="bg-white rounded-2xl shadow-lg border border-gray-200 w-full max-w-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Painel de Gerentes (v2)</h1>
            <p class="text-gray-600 text-center mb-8">Selecione o seu segmento para aceder ao painel.</p>
            
            <div id="manager-login-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Botões de login serão inseridos aqui pelo JS -->
            </div>
            
            <div class="mt-8">
                <input type="password" id="manager-password-input" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite a sua senha...">
                <button id="manager-login-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm mt-3 h-4 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Tela Principal (Dashboard) -->
    <div id="dashboard" class="hidden container mx-auto p-4 md:p-8">
        
        <header class="flex justify-between items-center mb-8">
            <h1 id="dashboard-title" class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg text-sm hover:bg-red-600">Sair</button>
        </header>

        <!-- Estado de Carregamento (NOVO) -->
        <div id="loading-state" class="hidden text-center p-12">
            <h2 class="text-2xl font-semibold text-gray-700">A carregar dados...</h2>
            <p id="loading-message" class="text-gray-500 mt-2">A processar amostras. Isto pode demorar um momento...</p>
        </div>

        <!-- Conteúdo do Dashboard (NOVO) -->
        <div id="dashboard-content" class="hidden">
            <!-- Gráficos -->
            <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Status do Segmento</h3>
                    <div style="height: 250px;"><canvas id="segment-status-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-lg mb-2 text-center">Distribuição de Feedbacks</h3>
                    <div style="height: 250px;"><canvas id="rejection-rate-chart"></canvas></div>
                </div>
            </section>

            <!-- Feeds Lado a Lado -->
            <section class="grid grid-cols-1 md:grid-cols-2 md:items-start gap-6 mb-10">
                <!-- Coluna Vendedores -->
                <section>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Vendedores do Segmento</h2>
                    <input id="seller-search-input" type="text" placeholder="Procurar vendedor..." class="border-gray-300 rounded-lg shadow-sm text-sm w-full mb-4">
                    <div id="sellers-list" class="seller-list-container space-y-3 bg-white p-4 rounded-2xl shadow-sm border no-scrollbar">
                        <p class="text-gray-500 placeholder-seller">Nenhum vendedor encontrado para este segmento.</p>
                    </div>
                </section>
                
                <!-- Coluna Feed Observações -->
                <section>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Feed de Observações</h2>
                    <div class="mb-4">
                        <input id="observation-search-input" type="text" placeholder="Pesquisar por cliente, produto..." class="border-gray-300 rounded-lg shadow-sm text-sm w-full">
                    </div>
                    <div id="observations-feed-list" class="space-y-4 h-[28rem] overflow-y-auto bg-white p-4 rounded-2xl shadow-sm border no-scrollbar">
                        <p class="text-gray-500 placeholder-observation">Nenhuma observação encontrada.</p>
                    </div>
                </section>
            </section>

            <!-- Tabela de Acessos (Admin) -->
            <section id="admin-access-section" class="hidden bg-white p-6 rounded-2xl shadow-sm border mb-10">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Acessos de Gerentes (Admin)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Segmento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Senha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="manager-access-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Linhas inseridas pelo JS -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Modais -->
    
    <!-- Modal de Amostras por Feedback -->
    <div id="feedback-samples-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="feedback-samples-title" class="text-xl font-bold">Amostras com Feedback:</h3>
                <button id="close-feedback-samples-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="feedback-samples-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                <p class="text-gray-500">A carregar detalhes...</p>
            </div>
        </div>
    </div>

    <!-- Modal de Resposta à Observação -->
    <div id="reply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
            <h3 class="text-xl font-bold mb-4">Responder à Observação</h3>
            <div class="mb-4 p-3 bg-gray-100 rounded border text-sm">
                <p class="font-semibold" id="reply-modal-product"></p>
                <p class="text-xs text-gray-600 mb-1" id="reply-modal-seller"></p>
                <p class="italic" id="reply-modal-observation">"${' '}"</p>
            </div>
            <div class="space-y-4">
                <div>
                  <label for="reply-message-input" class="block text-sm font-medium text-gray-700">Sua Resposta</label>
                  <textarea id="reply-message-input" rows="3" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm" placeholder="Digite sua resposta aqui..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-reply-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="send-reply-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Enviar Resposta</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificações (Respostas dos Vendedores) -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold">Respostas dos Vendedores</h3>
                <button id="close-notification-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="notification-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <p class="text-gray-500">Nenhuma resposta recebida.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Customizado -->
    <div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-red-600">Erro na Operação</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6">Ocorreu um erro.</p>
            <div class="flex justify-end">
                <button id="custom-alert-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, getDocs, 
            updateDoc, query, orderBy, serverTimestamp, addDoc, limit, where,
            collectionGroup // Importar collectionGroup
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAF_TE28Tbp2nakBGTva1yEEbBCqWvRdJQ",
            authDomain: "feedback-vendedores.firebaseapp.com",
            projectId: "feedback-vendedores",
            storageBucket: "feedback-vendedores.firebasestorage.app",
            messagingSenderId: "650880422749",
            appId: "1:650880422749:web:54a258964a6ca8db180eb4",
            measurementId: "G-TG588KDK0C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Definições de Acesso
        const MANAGER_PASSWORDS = {
            'CÁRNEOS': 'carneospass123',
            'LACTEOS': 'lacteospass456',
            'NUTRICAO ANIMAL': 'nutricaopass303',
            'PANIFICACAO': 'panificacaopass101',
            'SMB': 'smbpass202',
            'SORVETES': 'sorvetespass789',
            'ADMIN': 'admin123' // Senha de Admin
        };
        const PENDING_STATUSES = ['EM ANÁLISE', 'AMOSTRA SEM FEEDBACK', 'SEM RETORNO DO CLIENTE', 'AMOSTRA NÃO TESTADA', 'PENDENTE'];
        
        // --- Elementos DOM ---
        const loginView = document.getElementById('login-view');
        const managerLoginButtons = document.getElementById('manager-login-buttons');
        const managerPasswordInput = document.getElementById('manager-password-input');
        const managerLoginBtn = document.getElementById('manager-login-btn');
        const loginError = document.getElementById('login-error');
        const dashboard = document.getElementById('dashboard');
        const dashboardTitle = document.getElementById('dashboard-title');
        const logoutBtn = document.getElementById('logout-btn');
        const loadingState = document.getElementById('loading-state');
        const loadingMessage = document.getElementById('loading-message');
        const dashboardContent = document.getElementById('dashboard-content');
        const sellersList = document.getElementById('sellers-list');
        const sellerSearchInput = document.getElementById('seller-search-input');
        const observationsFeedList = document.getElementById('observations-feed-list');
        const observationSearchInput = document.getElementById('observation-search-input');
        const adminAccessSection = document.getElementById('admin-access-section');
        const managerAccessTbody = document.getElementById('manager-access-tbody');
        const feedbackSamplesModal = document.getElementById('feedback-samples-modal');
        const feedbackSamplesTitle = document.getElementById('feedback-samples-title');
        const feedbackSamplesList = document.getElementById('feedback-samples-list');
        const closeFeedbackSamplesBtn = document.getElementById('close-feedback-samples-btn');
        const replyModal = document.getElementById('reply-modal');
        const replyModalProduct = document.getElementById('reply-modal-product');
        const replyModalSeller = document.getElementById('reply-modal-seller');
        const replyModalObservation = document.getElementById('reply-modal-observation');
        const replyMessageInput = document.getElementById('reply-message-input');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const sendReplyBtn = document.getElementById('send-reply-btn');
        const notificationModal = document.getElementById('notification-modal');
        const notificationList = document.getElementById('notification-list');
        const closeNotificationBtn = document.getElementById('close-notification-btn');
        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');

        // --- Estado Global ---
        let currentSessionId = null;
        let currentSegment = null; // Segmento do gerente logado
        let currentManagerName = null; // Nome do gerente logado
        let allCurrentSamples = []; // Armazena TODAS as amostras carregadas
        let sellerSegmentsCache = {}; // Cache de segmentos de vendedores
        let sellerRepliesListenerUnsubscribe = null;
        let dataListenersUnsubscribe = []; // Array para armazenar todos os listeners de dados
        let chartInstances = {};
        let currentSampleForReply = null;
        
        // Classe para gerir carregamento de dados (evita "piscar")
        class DataLoadManager {
            constructor(totalItems, onComplete) {
                this.totalItems = totalItems;
                this.loadedItems = 0;
                this.allData = [];
                this.onComplete = onComplete;
                this.hasCompleted = false;
            }

            itemLoaded(data) {
                this.loadedItems++;
                this.allData = this.allData.concat(data);
                
                const progress = this.totalItems > 0 ? (this.loadedItems / this.totalItems) * 100 : 100;
                loadingMessage.textContent = `A processar... (${this.loadedItems}/${this.totalItems} vendedores carregados)`;

                if (this.loadedItems === this.totalItems && !this.hasCompleted) {
                    this.hasCompleted = true;
                    this.onComplete(this.allData);
                }
            }
        }

        // --- Funções Utilitárias ---
        const normalizeText = (text = '') => text ? text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : '';

        function showAlert(message, title = "Erro na Operação", color = "text-red-600") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message;
            customAlertTitle.className = `text-xl font-bold mb-4 ${color}`;
            customAlert.classList.remove('hidden');
        }
        customAlertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

        function handleFirestoreError(error, operationContext) {
            console.error(`Erro em "${operationContext}":`, error);
            let message = `Não foi possível completar a operação: ${operationContext}.<br><br>Erro: ${error.message}`;
            let title = "Erro na Operação";
            let color = "text-red-600";

            if (error.code === 'resource-exhausted' || (error.message && error.message.includes('Quota exceeded'))) {
                message = "O limite diário de uso do banco de dados foi atingido (Quota Exceeded). Novas alterações não serão salvas hoje.<br><br>Por favor, tente novamente amanhã.";
                title = "Limite da Plataforma Atingido";
                color = "text-amber-600";
            } else if (error.code === 'permission-denied') {
                message = "Permissão negada. Verifique as regras de segurança do Firebase.";
            }
            showAlert(message, title, color);
        }

        // --- Lógica de Carregamento de Dados (v2) ---
        
        // Busca a sessão ativa (v2)
        async function getActiveSessionId() {
            try {
                const activeSessionRef = doc(db, "configuracoes", "sessaoAtiva");
                const docSnap = await getDoc(activeSessionRef);
                if (docSnap.exists() && docSnap.data().current) {
                    return docSnap.data().current;
                } else {
                    return null;
                }
            } catch (error) {
                handleFirestoreError(error, "buscar sessão ativa");
                return null;
            }
        }

        // Carrega os segmentos de todos os vendedores (v2)
        async function loadSellerSegments() {
            sellerSegmentsCache = {};
            try {
                const segmentsSnap = await getDocs(collection(db, "vendedorConfig"));
                segmentsSnap.forEach(doc => {
                    // ID do doc é o nome normalizado
                    sellerSegmentsCache[doc.id] = doc.data().segmento;
                });
                console.log("Cache de segmentos carregado:", sellerSegmentsCache);
            } catch (error) {
                handleFirestoreError(error, "carregar segmentos de vendedores");
            }
        }

        // Carrega TODOS os dados da sessão (v2)
        async function loadAllData(sessionId, segmentFilter) {
            dashboard.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            loginView.classList.add('hidden');
            
            // Limpa listeners antigos
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            
            currentSessionId = sessionId;
            allCurrentSamples = [];

            // 1. Carrega os segmentos primeiro
            await loadSellerSegments();

            // 2. Busca todos os vendedores da sessão
            let sellersQuery;
            if (segmentFilter === 'ADMIN') {
                sellersQuery = query(collection(db, "sessoes", sessionId, "vendedores"));
            } else {
                // Se não for admin, pré-filtra os vendedores pelo segmento
                const sellerIdsInSegment = Object.entries(sellerSegmentsCache)
                    .filter(([normalizedName, segment]) => segment === segmentFilter)
                    .map(([normalizedName]) => normalizedName);
                
                if (sellerIdsInSegment.length === 0) {
                     console.warn(`Nenhum vendedor encontrado para o segmento ${segmentFilter}`);
                     loadingState.classList.add('hidden');
                     dashboardContent.classList.remove('hidden');
                     processAndDisplayDashboard([]);
                     listenForSellerReplies(sessionId, segmentFilter); // Ainda ouve respostas
                     return;
                }
                
                sellersQuery = query(
                    collection(db, "sessoes", sessionId, "vendedores"),
                    where('id', 'in', sellerIdsInSegment) // 'id' aqui é o nome normalizado
                );
            }
            
            const sellersSnapshot = await getDocs(sellersQuery);
            const sellerDocs = sellersSnapshot.docs;
            
            if (sellerDocs.length === 0) {
                 console.log("Nenhum vendedor encontrado para esta sessão/segmento.");
                 loadingState.classList.add('hidden');
                 dashboardContent.classList.remove('hidden');
                 processAndDisplayDashboard([]);
                 listenForSellerReplies(sessionId, segmentFilter);
                 return;
            }

            // 3. Usa o DataLoadManager para carregar as sub-coleções
            const loadManager = new DataLoadManager(sellerDocs.length, (allSamples) => {
                allCurrentSamples = allSamples;
                processAndDisplayDashboard(allCurrentSamples);
                loadingState.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
            });
            
            loadingMessage.textContent = `A preparar para carregar ${sellerDocs.length} vendedores...`;

            // 4. Ouve as 'amostras' de cada vendedor
            sellerDocs.forEach(sellerDoc => {
                const sellerData = sellerDoc.data();
                const samplesQuery = query(
                    collection(db, sellerDoc.ref.path, "amostras")
                );

                const unsub = onSnapshot(samplesQuery, (samplesSnapshot) => {
                    const samples = samplesSnapshot.docs.map(sampleDoc => ({
                        ...sampleDoc.data(),
                        id: sampleDoc.id,
                        sellerName: sellerData.originalName // Adiciona o nome original
                    }));
                    loadManager.itemLoaded(samples);
                }, (error) => {
                    handleFirestoreError(error, `ouvir amostras de ${sellerData.originalName}`);
                    loadManager.itemLoaded([]); // Continua mesmo se um falhar
                });
                dataListenersUnsubscribe.push(unsub);
            });
            
            // 5. Ouve as respostas dos vendedores
            listenForSellerReplies(sessionId, segmentFilter);
        }

        // --- Lógica de Login ---
        function populateManagerButtons() {
            managerLoginButtons.innerHTML = '';
            Object.keys(MANAGER_PASSWORDS).forEach(segment => {
                const button = document.createElement('button');
                button.className = "p-4 bg-gray-100 rounded-lg font-semibold text-gray-700 hover:bg-blue-100 border border-transparent hover:border-blue-300 transition";
                button.textContent = segment;
                button.dataset.segment = segment;
                button.addEventListener('click', () => {
                    managerLoginButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
                    button.classList.add('bg-blue-600', 'text-white');
                    currentSegment = segment;
                    currentManagerName = segment; // Define o nome do gerente
                });
                managerLoginButtons.appendChild(button);
            });
        }

        async function login() {
            const password = managerPasswordInput.value;
            if (!currentSegment) {
                loginError.textContent = 'Por favor, selecione o seu segmento.';
                return;
            }
            
            if (MANAGER_PASSWORDS[currentSegment] === password) {
                loginError.textContent = '';
                managerLoginBtn.disabled = true;
                managerLoginBtn.textContent = 'A carregar...';

                // Salva o segmento
                localStorage.setItem('managerSegment', currentSegment);
                
                // Carrega a sessão ativa e os dados
                const sessionId = await getActiveSessionId();
                if (!sessionId) {
                    loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                    managerLoginBtn.disabled = false;
                    managerLoginBtn.textContent = 'Entrar';
                    return;
                }
                
                dashboardTitle.textContent = `Painel: ${currentSegment}`;
                if (currentSegment === 'ADMIN') {
                    adminAccessSection.classList.remove('hidden');
                    renderAccessTable();
                }
                
                await loadAllData(sessionId, currentSegment);

            } else {
                loginError.textContent = 'Senha incorreta.';
            }
        }
        
        function logout() {
            localStorage.removeItem('managerSegment');
            currentSessionId = null;
            currentSegment = null;
            currentManagerName = null;
            allCurrentSamples = [];
            dataListenersUnsubscribe.forEach(unsub => unsub());
            dataListenersUnsubscribe = [];
            if(sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            
            dashboard.classList.add('hidden');
            loginView.classList.remove('hidden');
            managerPasswordInput.value = '';
            managerLoginBtn.disabled = false;
            managerLoginBtn.textContent = 'Entrar';
            adminAccessSection.classList.add('hidden');
            managerLoginButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
        }

        // --- Processamento e Renderização do Dashboard ---
        function processAndDisplayDashboard(samples) {
            if (!samples) return;
            renderCharts(samples);
            renderSellersList(samples);
            renderObservationsFeed(samples);
        }

        function renderCharts(samples) {
            let pending = 0, resolved = 0, approved = 0, rejected = 0, events = 0;
            const feedbackCounts = {};
            const APPROVED_PREFIX = 'A -';
            const REJECTED_PREFIX = 'R -';
            const EVENTS_PREFIX = 'E -';

            samples.forEach(s => {
                if (s.isPending) {
                    pending++;
                } else {
                    resolved++;
                    const feedback = s.feedback || '';
                    if (feedback) {
                        feedbackCounts[feedback] = (feedbackCounts[feedback] || 0) + 1;
                        if (feedback.startsWith(APPROVED_PREFIX)) approved++;
                        else if (feedback.startsWith(REJECTED_PREFIX)) rejected++;
                        else if (feedback.startsWith(EVENTS_PREFIX)) events++;
                    }
                }
            });

            renderChart('segment-status-chart', 'doughnut', {
                labels: ['Pendentes', 'Resolvidos'],
                datasets: [{ data: [pending, resolved], backgroundColor: ['#facc15', '#3b82f6'] }]
            });

            if (approved === 0 && rejected === 0 && events === 0) {
                 renderChart('rejection-rate-chart', 'doughnut', { labels: ['Aguardando Respostas'], datasets: [{ data: [1], backgroundColor: ['#e5e7eb'] }] });
            } else {
                renderChart('rejection-rate-chart', 'doughnut', {
                    labels: ['Aprovadas', 'Reprovadas', 'Eventos'],
                    datasets: [{
                        data: [approved, rejected, events],
                        backgroundColor: ['#34d399', '#f87171', '#a78bfa']
                    }]
                });
            }
        }

        function renderChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            
            Chart.register(ChartDataLabels);
            chartInstances[canvasId] = new Chart(ctx, { 
                type, 
                data, 
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type === 'doughnut' },
                        datalabels: { display: false },
                        ...options.plugins
                    },
                    ...options
                }
            });
        }
        
        function renderSellersList(samples) {
            const sellersMap = new Map();
            samples.forEach(s => {
                if (!sellersMap.has(s.sellerName)) {
                    sellersMap.set(s.sellerName, { name: s.sellerName, total: 0, pending: 0 });
                }
                const seller = sellersMap.get(s.sellerName);
                seller.total++;
                if (s.isPending) seller.pending++;
            });
            
            const sortedSellers = Array.from(sellersMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            
            sellersList.innerHTML = '';
            if(sortedSellers.length === 0) {
                 sellersList.innerHTML = '<p class="text-gray-500 placeholder-seller">Nenhum vendedor encontrado para este segmento.</p>';
                 return;
            }
            
            sortedSellers.forEach(seller => {
                const item = document.createElement('div');
                item.className = "p-3 rounded-lg border bg-white flex justify-between items-center";
                item.dataset.sellerName = seller.name;
                
                const progress = seller.total > 0 ? (seller.total - seller.pending) / seller.total : 0;
                const percentage = (progress * 100).toFixed(0);
                const color = progress === 1 ? 'green' : (progress > 0.5 ? 'blue' : 'yellow');
                
                item.innerHTML = `
                    <div>
                        <p class="font-semibold">${seller.name}</p>
                        <p class="text-xs ${seller.pending > 0 ? 'text-red-500' : 'text-green-600'}">
                            ${seller.pending > 0 ? `${seller.pending} pendente(s)` : 'Concluído'}
                        </p>
                    </div>
                    <div class="flex items-center gap-2">
                         <span class="text-sm font-semibold text-${color}-600">${percentage}%</span>
                         <div class="w-16 h-2 bg-gray-200 rounded-full">
                            <div class="h-2 bg-${color}-500 rounded-full" style="width: ${percentage}%"></div>
                         </div>
                    </div>
                `;
                sellersList.appendChild(item);
            });
            filterSellersList(); // Aplicar filtro
        }
        
        function filterSellersList() {
             const searchTerm = normalizeText(sellerSearchInput.value);
             sellersList.querySelectorAll('div[data-seller-name]').forEach(item => {
                 const name = normalizeText(item.dataset.sellerName);
                 item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
             });
        }

        function renderObservationsFeed(samples) {
            const searchTerm = normalizeText(observationSearchInput.value);
            
            const filteredSamples = samples.filter(s => 
                s.observation && (
                    !searchTerm ||
                    normalizeText(s.sellerName).includes(searchTerm) ||
                    normalizeText(s.produto).includes(searchTerm) ||
                    normalizeText(s.descricao).includes(searchTerm) ||
                    normalizeText(s.razaoSocial).includes(searchTerm) ||
                    normalizeText(s.observation).includes(searchTerm)
                )
            ).sort((a, b) => (b.lastUpdate?.toDate ? b.lastUpdate.toDate().getTime() : 0) - (a.lastUpdate?.toDate ? a.lastUpdate.toDate().getTime() : 0));
            
            observationsFeedList.innerHTML = '';
            if (filteredSamples.length === 0) {
                 observationsFeedList.innerHTML = '<p class="text-gray-500 placeholder-observation">Nenhuma observação encontrada.</p>';
                 return;
            }
            
            filteredSamples.forEach(sample => {
                 const card = document.createElement('div');
                 card.className = "p-4 rounded-lg border bg-gray-50";
                 const time = sample.lastUpdate?.toDate() ? sample.lastUpdate.toDate().toLocaleString('pt-BR') : 'data inválida';
                 
                 card.innerHTML = `
                    <div class="mb-2">
                        <p class="font-bold text-gray-800">${sample.produto}</p>
                        <p class="text-xs text-gray-500">${sample.razaoSocial || 'Cliente N/A'}</p>
                    </div>
                    <p class="text-gray-700 mb-3">"${sample.observation}"</p>
                    <!-- Respostas serão adicionadas aqui por outro listener, se necessário -->
                    <div class="flex justify-between items-end text-xs text-gray-500 mt-3">
                         <div>
                             <p>- ${sample.sellerName} (Pedido: ${sample.pedido})</p>
                             <p class="text-gray-400">${time}</p>
                         </div>
                        <button class="reply-observation-btn bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs font-semibold" data-sample-id="${sample.id}">
                            Responder
                        </button>
                    </div>
                 `;
                 observationsFeedList.appendChild(card);
            });
            
            observationsFeedList.querySelectorAll('.reply-observation-btn').forEach(btn => {
                 btn.addEventListener('click', openReplyModal);
            });
        }
        
        function renderAccessTable() {
             managerAccessTbody.innerHTML = '';
             Object.entries(MANAGER_PASSWORDS).forEach(([segment, password]) => {
                 if(segment === 'ADMIN') return; // Não mostrar Admin na tabela
                 const row = document.createElement('tr');
                 row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${segment}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 password-cell" data-password="${password}">••••••</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="toggle-password-btn text-blue-600 hover:text-blue-800" data-state="hidden">Visualizar</button>
                    </td>
                 `;
                 managerAccessTbody.appendChild(row);
             });
        }

        // --- Lógica de Resposta e Notificação ---
        
        function openReplyModal(e) {
             const sampleId = e.currentTarget.dataset.sampleId;
             currentSampleForReply = allCurrentSamples.find(s => s.id === sampleId);
             if (!currentSampleForReply) {
                 showAlert("Erro: Amostra não encontrada.");
                 return;
             }
             
             replyModalProduct.textContent = `${currentSampleForReply.produto} (${currentSampleForReply.pedido})`;
             replyModalSeller.textContent = `Observação de: ${currentSampleForReply.sellerName}`;
             replyModalObservation.textContent = `"${currentSampleForReply.observation}"`;
             replyMessageInput.value = '';
             replyModal.classList.remove('hidden');
        }

        async function sendReplyToSeller() {
            if (!currentSampleForReply || !currentSessionId) return;
            
            const replyMessage = replyMessageInput.value.trim();
            if (!replyMessage || !currentManagerName) {
                showAlert("A mensagem de resposta não pode estar vazia.");
                return;
            }

            sendReplyBtn.disabled = true;
            sendReplyBtn.textContent = 'A Enviar...';

            try {
                // ATUALIZAÇÃO v2: Envia todos os dados para o modal do vendedor
                const notificationData = {
                    managerName: currentManagerName,
                    replyMessage: replyMessage,
                    originalObservation: currentSampleForReply.observation,
                    sellerName: currentSampleForReply.sellerName,
                    pedido: currentSampleForReply.pedido,
                    produto: currentSampleForReply.produto,
                    razaoSocial: currentSampleForReply.razaoSocial || '', // NOVO
                    descricao: currentSampleForReply.descricao || '', // NOVO
                    timestamp: serverTimestamp(),
                    read: false,
                };

                const sellerNotifsRef = collection(db, "sessoes", currentSessionId, "notificacoesVendedor");
                await addDoc(sellerNotifsRef, notificationData);

                replyModal.classList.add('hidden');
                showAlert("Resposta enviada com sucesso.", "Sucesso", "text-green-600");
                
            } catch (error) {
                handleFirestoreError(error, "enviar resposta ao vendedor");
            } finally {
                sendReplyBtn.disabled = false;
                sendReplyBtn.textContent = 'Enviar Resposta';
                currentSampleForReply = null;
            }
        }
        
        // Ouve respostas dos vendedores (para o sino)
        function listenForSellerReplies(sessionId, segmentFilter) {
            if (sellerRepliesListenerUnsubscribe) sellerRepliesListenerUnsubscribe();
            
            let q;
            if (segmentFilter === 'ADMIN') {
                 q = query(
                     collection(db, "sessoes", sessionId, "respostasVendedor"),
                     where("readByManager", "==", false)
                 );
            } else {
                // Gerentes normais só veem respostas dos seus vendedores
                const sellerNamesInSegment = Object.entries(sellerSegmentsCache)
                    .filter(([normalizedName, segment]) => segment === segmentFilter)
                    .map(([normalizedName]) => {
                        // Tentar encontrar o nome original
                        const sample = allCurrentSamples.find(s => normalizeText(s.sellerName) === normalizedName);
                        return sample ? sample.sellerName : normalizedName; // Fallback para nome normalizado
                    });

                if (sellerNamesInSegment.length === 0) return; // Não há vendedores, não ouve

                 q = query(
                     collection(db, "sessoes", sessionId, "respostasVendedor"),
                     where("readByManager", "==", false),
                     where("sellerName", "in", sellerNamesInSegment)
                 );
            }

            sellerRepliesListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                const replies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotificationBell(replies);
            }, (error) => {
                handleFirestoreError(error, "ouvir respostas dos vendedores");
            });
        }
        
        function renderNotificationBell(replies) {
             const unreadCount = replies.length;
             // CORREÇÃO: Mudar 'const' para 'let'
             let bellBtn = document.getElementById('notification-btn'); // Botão do sino
             let countBadge = document.getElementById('notification-count-badge');
             
             if (!bellBtn) { // Cria o botão se não existir
                const header = document.querySelector('#dashboard header');
                const bellWrapper = document.createElement('div');
                bellWrapper.className = "relative";
                bellWrapper.innerHTML = `
                    <button id="notification-btn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span id="notification-count-badge" class="hidden absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">0</span>
                    </button>
                `;
                header.insertBefore(bellWrapper, logoutBtn);
                bellBtn = document.getElementById('notification-btn');
                countBadge = document.getElementById('notification-count-badge');
                bellBtn.addEventListener('click', () => openNotificationModal(replies));
             }
             
             if (unreadCount > 0) {
                 countBadge.textContent = unreadCount;
                 countBadge.classList.remove('hidden');
             } else {
                 countBadge.classList.add('hidden');
             }
        }
        
        function openNotificationModal(replies) {
             notificationList.innerHTML = '';
             if (replies.length === 0) {
                 notificationList.innerHTML = '<p class="text-gray-500">Nenhuma resposta nova dos vendedores.</p>';
                 return;
             }
             
             replies.sort((a,b) => (b.timestamp?.toDate() ?? 0) - (a.timestamp?.toDate() ?? 0));
             
             replies.forEach(reply => {
                 const item = document.createElement('div');
                 item.className = "p-3 border-b border-gray-100";
                 item.innerHTML = `
                    <p class="font-semibold">${reply.sellerName} respondeu:</p>
                    <p class="italic text-gray-700 my-1">"${reply.replyMessage}"</p>
                    <p class="text-xs text-gray-500">Ref: ${reply.produto} (Pedido: ${reply.pedido})</p>
                    <p class="text-xs text-gray-400">Mensagem original: "${reply.originalManagerMessage}"</p>
                    <div class="text-right mt-2">
                        <button class="mark-as-read-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-3 rounded hover:bg-gray-300" data-reply-id="${reply.id}">Marcar como Lida</button>
                    </div>
                 `;
                 notificationList.appendChild(item);
             });
             notificationModal.classList.remove('hidden');
        }
        
        async function markReplyAsRead(e) {
             const button = e.target;
             const replyId = button.dataset.replyId;
             button.disabled = true;
             button.textContent = 'A marcar...';
             
             try {
                 const replyRef = doc(db, "sessoes", currentSessionId, "respostasVendedor", replyId);
                 await updateDoc(replyRef, { readByManager: true });
                 // O listener de 'listenForSellerReplies' vai atualizar o sino automaticamente
                 notificationModal.classList.add('hidden'); // Fecha o modal
             } catch (error) {
                 handleFirestoreError(error, "marcar resposta como lida");
                 button.disabled = false;
                 button.textContent = 'Marcar como Lida';
             }
        }


        // --- Event Listeners Globais ---
        managerLoginBtn.addEventListener('click', login);
        logoutBtn.addEventListener('click', logout);
        sellerSearchInput.addEventListener('input', filterSellersList);
        observationSearchInput.addEventListener('input', () => renderObservationsFeed(allCurrentSamples));
        closeFeedbackSamplesBtn.addEventListener('click', () => feedbackSamplesModal.classList.add('hidden'));
        cancelReplyBtn.addEventListener('click', () => replyModal.classList.add('hidden'));
        sendReplyBtn.addEventListener('click', sendReplyToSeller);
        closeNotificationBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));
        notificationList.addEventListener('click', (e) => {
            const button = e.target.closest('.mark-as-read-btn');
            if (button) markReplyAsRead({ target: button });
        });

        // Tabela de Acessos (Admin)
        managerAccessTbody.addEventListener('click', (e) => {
            const button = e.target.closest('.toggle-password-btn');
            if (button) {
                const cell = button.closest('tr').querySelector('.password-cell');
                const password = cell.dataset.password;

                if (button.dataset.state === 'hidden') {
                    cell.textContent = password;
                    button.textContent = 'Ocultar';
                    button.dataset.state = 'visible';
                } else {
                    cell.textContent = '••••••';
                    button.textContent = 'Visualizar';
                    button.dataset.state = 'hidden';
                }
            }
        });

        // --- INICIALIZAÇÃO ---
        (async () => {
            try {
                await signInAnonymously(auth);
                populateManagerButtons();
                
                // Tenta fazer login automático se já esteve logado
                const savedSegment = localStorage.getItem('managerSegment');
                if (savedSegment) {
                    currentSegment = savedSegment;
                    currentManagerName = savedSegment;
                    managerLoginBtn.disabled = true;
                    managerLoginBtn.textContent = 'A carregar...';
                    
                    const sessionId = await getActiveSessionId();
                    if (!sessionId) {
                        loginError.textContent = 'Nenhuma sessão ativa encontrada. Contate o administrador.';
                        logout(); // Limpa o estado
                        return;
                    }
                    
                    dashboardTitle.textContent = `Painel: ${currentSegment}`;
                    if (currentSegment === 'ADMIN') {
                        adminAccessSection.classList.remove('hidden');
                        renderAccessTable();
                    }
                    
                    await loadAllData(sessionId, currentSegment);
                }
                
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                document.body.innerHTML = '<p class="text-center text-red-500 p-8">Erro crítico ao conectar com o Firebase. Verifique a configuração.</p>';
            }
        })();

    </script>
</body>
</html>

























